<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM - Flow Studio</title>
    
    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Librerías JS -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- ESTILOS OPTIMIZADOS --- */
        :root { 
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --bg-card: #1e293b; --bg-input: #020617;
            --border: #334155; --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; margin: 0; height: 100dvh; background: var(--bg-body); color: var(--text-main); overflow: hidden; font-size: 14px; }

        /* Layout */
        #mainApp { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        #mainApp.visible { opacity: 1; pointer-events: all; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 200; transition: transform 0.3s; flex-shrink: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }
        
        .brand { height: 64px; padding: 0 24px; display: flex; align-items: center; gap: 12px; font-weight: 700; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .menu { padding: 20px 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .menu-item { padding: 12px 16px; border-radius: 8px; font-weight: 500; color: var(--text-muted); display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { background: var(--border); color: var(--text-main); }
        .menu-item.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; font-weight: 600; }
        
        #installAppBtn { display: none; background: rgba(16, 185, 129, 0.1); color: #34d399; margin-top: 10px; border: 1px dashed rgba(16, 185, 129, 0.3); }

        /* Content */
        .content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
        .mobile-header { display: none; background: var(--bg-sidebar); height: 60px; padding: 0 20px; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        
        /* Views */
        .view { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; }
        .view.active { display: flex; animation: fadeIn 0.3s ease; }
        .view-padding { padding: 30px; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 20px; }
        .act-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .act-table th, .act-table td { padding: 14px; border-bottom: 1px solid var(--border); text-align: left; color: var(--text-muted); }
        .act-table tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
        .status-badge.connected { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .status-badge.disconnected { background: rgba(239, 68, 68, 0.15); color: #f87171; }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; text-align: center; }
        .admin-btn { padding: 6px 12px; border: 1px solid var(--border); background: transparent; border-radius: 6px; cursor: pointer; color: var(--text-main); margin-right: 5px; font-size: 0.8rem; }
        
        input, select, textarea { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-main); margin-bottom: 10px; }

        /* Mobile Adjustments */
        @media(max-width: 768px) { 
            #mainApp { flex-direction: column; } 
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 4px 0 20px rgba(0,0,0,0.8); } 
            .sidebar.active { transform: translateX(0); }
            .view-padding { padding: 10px !important; }
            .card { padding: 15px !important; }
        }

        /* Flow & Chat Styles */
        .flow-step-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .chat-container-wrapper { background: #0b101a; border: 1px solid var(--border); border-radius: var(--radius); flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; }
        .msg.bot { background: var(--bg-sidebar); color: var(--text-main); align-self: flex-start; }
        .msg.user { background: #005c4b; color: #e9edef; align-self: flex-end; }
        .fab { position: fixed; bottom: 25px; right: 25px; background: var(--primary); color: white; width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); z-index: 100; font-size: 24px; }

        /* Utils */
        .step-hidden { display: none !important; }
        #setupWizard { background: var(--bg-body); position: fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:flex; justify-content:center; align-items:center; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; pointer-events: none; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; color: var(--text-main); margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 300; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .sheet { background: var(--bg-card); width: 90%; max-width: 500px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <div id="toast-container"></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMenu()"></div>

    <!-- WIZARD INICIAL -->
    <div id="setupWizard" class="step-hidden">
        <div id="stepLoading" style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:2.5rem; color:var(--primary);"></i>
            <p style="margin-top:20px; color:var(--text-muted);">Conectando con el Servidor...</p>
        </div>
        <div id="stepQR" class="step-hidden" style="text-align:center;">
            <h2 style="margin-top:0;">Vincular WhatsApp</h2>
            <div style="background:white; padding:10px; display:inline-block; border-radius:10px; margin:15px 0;">
                <canvas id="qrCanvas"></canvas>
            </div>
            <p style="color:var(--success);">Escanea el código para activar el Bot</p>
        </div>
    </div>

    <!-- APLICACIÓN PRINCIPAL -->
    <div id="mainApp">
        <div class="sidebar" id="sidebar">
            <div class="brand"><i class="fas fa-robot" style="color:var(--primary);"></i> FLOW CRM</div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('flow', this)"><i class="fas fa-project-diagram"></i> Flujo del Bot</div>
                <div class="menu-item" onclick="nav('activity', this)">
                    <i class="fas fa-desktop"></i> Monitor
                    <!-- Indicador visual de conexión en el menú -->
                    <span id="socketDot" style="width:8px; height:8px; background:var(--danger); border-radius:50%; margin-left:auto; box-shadow:0 0 5px var(--danger);"></span>
                </div>
                <div class="menu-item" onclick="nav('agenda', this)"><i class="far fa-calendar-alt"></i> Agenda</div>
                <div class="menu-item" onclick="nav('contacts', this)"><i class="fas fa-users"></i> Contactos</div>
                <div class="menu-item" onclick="nav('sim', this)"><i class="fas fa-gamepad"></i> Simulador</div>
                
                <div class="menu-item" id="installAppBtn" onclick="installPWA()"><i class="fas fa-download"></i> Instalar App</div>
                <div class="menu-item logout" onclick="resetSession()"><i class="fas fa-power-off"></i> Desconectar</div>
            </div>
        </div>

        <div class="content">
            <div class="mobile-header">
                <button onclick="toggleMenu()" style="background:none; border:none; color:white; font-size:1.4rem;">☰</button>
                <span id="pageTitle" style="font-weight:700;">MONITOR</span>
                <!-- Indicador visual de conexión en el header móvil -->
                <div id="statusIndicator" class="status-badge disconnected">OFFLINE</div>
            </div>

            <!-- VISTA: MONITOR DE ACTIVIDAD -->
            <div id="view-activity" class="view view-padding">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>Monitor de Tráfico</h3>
                        <!-- Botón de alertas eliminado de aquí también, ya es automático -->
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="act-table">
                            <thead><tr><th>Cliente</th><th>Estado Actual</th><th>Acción</th></tr></thead>
                            <tbody id="activityBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VISTA: FLUJO -->
            <div id="view-flow" class="view active view-padding">
                <div id="flowListContainer"></div>
                <div class="fab" onclick="createNewStepPrompt()"><i class="fas fa-plus"></i></div>
            </div>

            <!-- VISTA: AGENDA -->
            <div id="view-agenda" class="view view-padding">
                <div class="card" style="text-align:center;">
                    <h3>Próximamente</h3>
                    <p style="color:var(--text-muted);">Módulo de Calendario Simplificado</p>
                </div>
            </div>

            <!-- VISTA: CONTACTOS -->
            <div id="view-contacts" class="view view-padding">
                <div class="card">
                    <h3>Base de Datos</h3>
                    <div id="contactsList"></div>
                </div>
            </div>

            <!-- VISTA: SIMULADOR -->
            <div id="view-sim" class="view view-padding">
                <div class="chat-container-wrapper">
                    <div class="chat-msgs" id="simMsgs"></div>
                    <div style="padding:15px; border-top:1px solid var(--border); display:flex; gap:10px;">
                        <input type="text" id="simInput" placeholder="Escribe al bot..." style="margin:0;">
                        <button onclick="sendSim()" class="btn-primary" style="width:auto;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- VISTA: CONFIGURACIÓN -->
            <div id="view-settings" class="view view-padding">
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <h3 style="margin-top:0;">Configuración de Horario</h3>
                    <div style="padding:20px; background:var(--bg-body); border-radius:8px; border:1px solid var(--border); margin-bottom:24px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div><label style="margin:0; font-size:0.95rem; color:var(--text-main); cursor:pointer;" for="schedActive">Restricción de Horario</label><p style="margin:4px 0 0 0; font-size:0.8rem; color:var(--text-muted);">Activa la respuesta automática de ausencia.</p></div>
                            <label class="switch"><input type="checkbox" id="schedActive"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                        <div><label>Hora Apertura</label><input type="time" id="schedStart"></div>
                        <div><label>Hora Cierre</label><input type="time" id="schedEnd"></div>
                    </div>
                    <label>Mensaje de Ausencia</label><textarea id="schedMsg" placeholder="Ej: Actualmente no estamos disponibles..." rows="4"></textarea>
                    <button onclick="saveSettings()" class="btn-primary" style="width:100%; margin-top:10px;">Guardar Configuración</button>
                    <!-- BOTÓN ELIMINADO COMO SOLICITASTE -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITOR -->
    <div class="modal" id="editorModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Editar Paso</h3>
                <button onclick="document.getElementById('editorModal').classList.remove('active')" style="background:none; border:none; color:white; font-size:1.2rem;">✕</button>
            </div>
            <input type="hidden" id="stId">
            <label>Tipo</label>
            <select id="stType" onchange="renderFields()">
                <option value="menu">Menú</option>
                <option value="filtro">Filtro Admin</option>
                <option value="input">Guardar Dato</option>
                <option value="message">Mensaje</option>
                <option value="fin_bot">Finalizar</option>
            </select>
            <div id="dynFields"></div>
            <button onclick="saveStep()" class="btn-primary" style="margin-top:20px;">Guardar Cambios</button>
            <button onclick="delStep()" style="background:transparent; color:var(--danger); border:1px solid var(--danger); padding:10px; border-radius:8px; margin-top:10px; width:100%;">Eliminar Paso</button>
        </div>
    </div>

<script>
    const API_BASE = ''; 
    let flow = {};
    let users = [];
    let pollingInterval = null;
    let deferredPrompt;

    // --- SOCKET.IO (EL CORAZÓN DEL TIEMPO REAL) ---
    const socket = io({
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: Infinity
    });

    socket.on('connect', () => {
        updateConnStatus(true);
        loadActivity(); // Cargar datos al reconectar
    });

    socket.on('disconnect', () => {
        updateConnStatus(false);
    });

    // ¡AQUÍ ESTÁ LA LÓGICA DE ACTUALIZACIÓN INSTANTÁNEA!
    socket.on('message', (data) => {
        // 1. Reproducir sonido si es mensaje nuevo de cliente
        if (!data.fromMe) {
            try {
                const audio = document.getElementById('alertSound');
                audio.volume = 0.5;
                audio.play().catch(e => console.log("Audio bloqueado por navegador"));
                
                // Notificación nativa (Background)
                if (document.visibilityState === 'hidden') {
                    new Notification("CRM: Nuevo Mensaje", { 
                        body: data.text || "Archivo recibido", 
                        icon: "logo.svg",
                        vibrate: [200, 100, 200]
                    });
                }
            } catch(e){}
        }

        // 2. ACTUALIZAR EL MONITOR INSTANTÁNEAMENTE
        loadActivity();

        // 3. Si es el simulador, pintar el chat
        const simPhone = '5218991234567';
        const destino = (data.to || '').replace(/\D/g, '');
        const origen = (data.from || '').replace(/\D/g, '');
        
        if (destino.includes(simPhone) || origen.includes(simPhone)) {
             addMsg(data.text, data.fromMe);
        }
    });

    function updateConnStatus(online) {
        const dot = document.getElementById('socketDot');
        const badge = document.getElementById('statusIndicator');
        
        if(online) {
            dot.style.background = 'var(--success)';
            dot.style.boxShadow = '0 0 5px var(--success)';
            badge.className = 'status-badge connected';
            badge.innerText = 'ONLINE';
        } else {
            dot.style.background = 'var(--danger)';
            dot.style.boxShadow = '0 0 5px var(--danger)';
            badge.className = 'status-badge disconnected';
            badge.innerText = 'OFFLINE';
        }
    }

    // --- PWA INSTALL ---
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installAppBtn').style.display = 'flex';
    });

    async function installPWA() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt = null;
    }

    // --- PERMISO DE NOTIFICACIONES (AUTOMÁTICO AL CLIC) ---
    document.addEventListener('click', function initAudioAndNotify() {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if(permission === 'granted') {
                    showToast('Alertas Activadas');
                }
            });
        }
        document.removeEventListener('click', initAudioAndNotify);
    }, { once: true });

    // --- LOGICA DE DATOS ---
    async function loadAll() {
        try { flow = await (await fetch(`${API_BASE}/api/flow`)).json(); renderFlowList(); } catch(e){}
        try { const set = await (await fetch(`${API_BASE}/api/settings`)).json(); if(set.schedule) { document.getElementById('schedActive').checked = set.schedule.active; document.getElementById('schedStart').value = set.schedule.start; document.getElementById('schedEnd').value = set.schedule.end; document.getElementById('schedMsg').value = set.schedule.offline_message; } } catch(e) {}
    }

    async function loadActivity() {
        // Esta función ahora es llamada por el Socket cada vez que alguien escribe
        try {
            users = await (await fetch(`${API_BASE}/api/users`)).json();
            const tb = document.getElementById('activityBody');
            tb.innerHTML = '';
            
            // Filtrar y ordenar
            let activeUsers = users.filter(u => u.phone !== 'TEST_SIMULADOR').sort((a,b) => new Date(b.last_active) - new Date(a.last_active));
            
            if(activeUsers.length === 0) {
                tb.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-muted);">Sin actividad reciente</td></tr>';
                return;
            }

            activeUsers.forEach(u => {
                const s = flow[u.current_step] || { type: 'unknown' };
                let btns = '';
                if(s.type === 'filtro' && s.options) {
                    s.options.forEach(o => {
                        btns += `<button class="admin-btn" onclick="crmAction('${u.phone}', '${o.next_step}')" style="border-color:var(--primary); color:var(--primary);">${o.label}</button>`;
                    });
                } else {
                    btns = `<span style="font-size:0.8rem; color:var(--text-muted);">Esperando usuario...</span>`;
                }

                tb.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:bold;">${u.phone}</div>
                            <small style="color:var(--text-muted);">${timeAgo(u.last_active)}</small>
                        </td>
                        <td><span class="status-badge connected" style="background:var(--bg-body); border:1px solid var(--border); color:var(--text-muted);">${u.current_step}</span></td>
                        <td>${btns}</td>
                    </tr>
                `;
            });
        } catch(e) {}
    }

    async function crmAction(phone, step) {
        await fetch(`${API_BASE}/api/crm/execute`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, stepId: step }) });
        loadActivity(); // Actualizar UI manual tras acción
    }

    // --- FLOW EDITOR LITE ---
    function renderFlowList() {
        const c = document.getElementById('flowListContainer'); c.innerHTML='';
        Object.keys(flow).sort().forEach(k => {
            const step = flow[k];
            c.innerHTML += `<div class="flow-step-card" onclick="edit('${k}')"><div><strong>${k}</strong><br><small style="color:var(--text-muted);">${step.type}</small></div><i class="fas fa-chevron-right"></i></div>`;
        });
    }
    
    function edit(id) {
        const d = flow[id]; document.getElementById('stId').value = id; document.getElementById('stType').value = d.type;
        renderFields(); document.getElementById('editorModal').classList.add('active');
    }

    function renderFields() {
        const type = document.getElementById('stType').value;
        const id = document.getElementById('stId').value;
        const d = flow[id] || {};
        const c = document.getElementById('dynFields');
        let html = `<label>Mensaje</label><textarea id="stMsg" rows="3">${d.message||''}</textarea>`;
        
        if(type === 'menu' || type === 'filtro') {
            html += `<label>Opciones (Texto Botón, Siguiente Paso)</label><div id="optsList">`;
            (d.options||[]).forEach(o => {
                 html += `<div style="display:flex; gap:5px; margin-bottom:5px;"><input class="o-lbl" value="${o.label}"><input class="o-nxt" value="${o.next_step}"></div>`;
            });
            html += `</div><button class="admin-btn" onclick="addOptRow()">+ Opción</button>`;
        } else {
            html += `<label>Siguiente Paso</label><input id="stNext" value="${d.next_step||''}">`;
        }
        c.innerHTML = html;
    }
    
    function addOptRow() { document.getElementById('optsList').insertAdjacentHTML('beforeend', `<div style="display:flex; gap:5px; margin-bottom:5px;"><input class="o-lbl" placeholder="Botón"><input class="o-nxt" placeholder="Sig. Paso"></div>`); }

    async function saveStep() {
        const id = document.getElementById('stId').value;
        const type = document.getElementById('stType').value;
        const msg = document.getElementById('stMsg').value;
        const data = { type, message: msg };
        
        if(document.getElementById('stNext')) data.next_step = document.getElementById('stNext').value;
        if(document.getElementById('optsList')) {
            data.options = [];
            document.querySelectorAll('#optsList div').forEach(row => {
                const l = row.querySelector('.o-lbl').value;
                const n = row.querySelector('.o-nxt').value;
                if(l && n) data.options.push({label:l, trigger:l, next_step:n});
            });
        }
        
        await fetch('/api/flow/step', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ stepId: id, stepData: data }) });
        flow[id] = data; renderFlowList(); document.getElementById('editorModal').classList.remove('active');
    }
    
    function createNewStepPrompt() {
        const name = prompt("Nombre del paso (MAYUSCULAS):");
        if(name) { flow[name] = {type:'message'}; renderFlowList(); edit(name); }
    }
    
    async function delStep() {
        const id = document.getElementById('stId').value;
        if(confirm("¿Eliminar?")) {
            await fetch('/api/flow/step/'+id, {method:'DELETE'});
            delete flow[id]; renderFlowList(); document.getElementById('editorModal').classList.remove('active');
        }
    }

    // --- UTILS ---
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
    function nav(v, btn) { 
        document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); 
        document.getElementById('view-'+v).classList.add('active');
        if(btn) btn.classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        if(v === 'activity') loadActivity();
    }
    function timeAgo(date) { 
        if(!date) return '-'; 
        const s = Math.floor((new Date() - new Date(date)) / 1000);
        if(s < 60) return 'Ahora';
        if(s < 3600) return Math.floor(s/60) + 'm';
        return Math.floor(s/3600) + 'h';
    }

    // --- INIT ---
    window.onload = () => {
        document.getElementById('setupWizard').classList.remove('step-hidden');
        
        // Polling para status de conexión inicial (QR)
        const checkStatus = async () => {
            try {
                const res = await (await fetch(`${API_BASE}/api/status`)).json();
                if(res.status === 'connected') {
                    document.getElementById('setupWizard').classList.add('step-hidden');
                    document.getElementById('mainApp').classList.add('visible');
                    loadAll();
                    loadActivity();
                } else if(res.qr) {
                    document.getElementById('stepLoading').classList.add('step-hidden');
                    document.getElementById('stepQR').classList.remove('step-hidden');
                    new QRious({element: document.getElementById('qrCanvas'), value: res.qr, size:200});
                }
            } catch(e){}
            if(document.getElementById('setupWizard').classList.contains('step-hidden')) return;
            setTimeout(checkStatus, 3000);
        };
        checkStatus();
    };
    
    // --- SIMULATOR ---
    function sendSim() { 
        const txt = document.getElementById('simInput').value; 
        if(!txt) return;
        addMsg(txt, true);
        document.getElementById('simInput').value = '';
        fetch(`${API_BASE}/api/simulate/text`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ phone: '5218991234567', text: txt }) });
    }
    function addMsg(txt, me) {
        document.getElementById('simMsgs').innerHTML += `<div class="msg ${me?'user':'bot'}">${txt}</div>`;
        const c = document.querySelector('.chat-msgs'); c.scrollTop = c.scrollHeight;
    }
    function resetSession() { fetch(`${API_BASE}/api/logout`, { method: 'POST' }).then(() => location.reload()); }
    function saveSettings() {
        const s = { active: document.getElementById('schedActive').checked, start: document.getElementById('schedStart').value, end: document.getElementById('schedEnd').value, offline_message: document.getElementById('schedMsg').value };
        fetch(`${API_BASE}/api/settings`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({schedule:s})}).then(()=>showToast('Configuración Guardada'));
    }
    function showToast(msg) {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast success`;
        t.innerHTML = `<span>${msg}</span>`;
        c.appendChild(t);
        setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
    }
</script>
</body>
</html>
