<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM - Monitor Dark</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
    <script src="https://unpkg.com/cytoscape-klay@3.1.4/cytoscape-klay.js"></script>

    <!-- Librer√≠a para QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- VARIABLES MODO OSCURO ELEGANTE (Black & Zinc) --- */
        :root { 
            --bg-body: #000000;       /* Negro puro */
            --bg-sidebar: #09090b;    /* Casi negro */
            --bg-card: #121212;       /* Gris muy oscuro para tarjetas */
            --bg-hover: #27272a;      /* Gris intermedio para hovers */
            
            --border: #27272a;        /* Bordes sutiles */
            
            --primary: #ffffff;       /* Blanco puro para acentos */
            --text-main: #e4e4e7;     /* Blanco humo para texto */
            --text-muted: #a1a1aa;    /* Gris claro para texto secundario */
            
            --accent-blue: #3b82f6;   
            --danger: #ef4444;
            --success: #10b981; 
            
            --shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 4px 12px rgba(0, 0, 0, 0.5);
            --radius: 8px;            /* Bordes m√°s rectos, m√°s profesionales */
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            height: 100dvh; 
            width: 100vw; 
            background: var(--bg-body); 
            color: var(--text-main); 
            overflow: hidden; 
        }

        /* --- LAYOUT PRINCIPAL (FLEXBOX CORREGIDO) --- */
        #mainApp {
            display: flex;       
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-body);
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 250px; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: 50; /* Z-index controlado */
            flex-shrink: 0; 
        }
        
        .brand { 
            padding: 20px; 
            color: var(--text-main); 
            font-weight: 600; 
            font-size: 1rem; 
            display: flex; 
            gap: 10px;
            align-items: center; 
            border-bottom: 1px solid var(--border);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .menu { padding: 15px; flex: 1; overflow-y: auto; }
        
        .menu-item { 
            padding: 12px; 
            margin-bottom: 4px; 
            cursor: pointer; 
            border-radius: var(--radius); 
            font-size: 0.9rem;
            font-weight: 400; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--text-muted); 
            transition: all 0.2s ease; 
        }
        
        .menu-item:hover { 
            background: var(--bg-hover); 
            color: var(--text-main); 
        }
        
        .menu-item.active { 
            background: var(--bg-hover); 
            color: var(--text-main); 
            font-weight: 500;
            border-left: 2px solid var(--primary);
        }
        
        .badge-count { 
            background: var(--danger); 
            color: white; 
            font-size: 0.65rem; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-left: auto;
            display: none; 
        }

        /* --- CONTENT AREA --- */
        .content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            height: 100%; 
            overflow: hidden; 
            background: var(--bg-body); 
        }
        
        .view { 
            display: none; 
            flex: 1; 
            overflow: hidden; /* Importante para el gr√°fico */
            flex-direction: column; 
            height: 100%; 
            position: relative;
        }
        .view.active { display: flex; }

        .view-padding { padding: 25px; overflow-y: auto; } /* Clase auxiliar para vistas con scroll */

        .mobile-header { 
            display: none; 
            background: var(--bg-sidebar); 
            padding: 0 15px; 
            height: 50px; 
            align-items: center; 
            color: var(--text-main); 
            justify-content: space-between; 
            flex-shrink: 0; 
            border-bottom: 1px solid var(--border); 
        }

        /* --- COMPONENTS --- */
        .card { 
            background: var(--bg-card); 
            padding: 20px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
            border: 1px solid var(--border); 
        }
        
        /* TABLA MODO OSCURO */
        .act-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; color: var(--text-main); }
        .act-table th { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 500; font-size: 0.8rem; text-transform: uppercase; }
        .act-table td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .act-table tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent; letter-spacing: 0.5px; }
        .status-badge.open { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.2); }
        .status-badge.closed { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: rgba(239, 68, 68, 0.2); }

        .admin-btn { 
            padding: 6px 12px; 
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.75rem; 
            font-weight: 500; 
            color: var(--text-main); 
            margin-right: 5px; 
            transition: all 0.2s; 
        }
        .admin-btn:hover { background: var(--bg-hover); border-color: var(--text-muted); }

        /* --- CALENDARIO DARK --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-header h3 { margin: 0; font-size: 1rem; color: var(--text-main); font-weight: 600; }
        .calendar-nav-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; }
        .calendar-nav-btn:hover { color: var(--text-main); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        
        .weekday { background: var(--bg-card); color: var(--text-muted); font-size: 0.7rem; text-align: center; padding: 10px 0; font-weight: 600; text-transform: uppercase; }
        
        .day { 
            height: 100px; 
            background: var(--bg-card);
            color: var(--text-muted);
            padding: 8px;
            font-size: 0.85rem;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .day:hover { background: var(--bg-hover); color: var(--text-main); }
        .day.today { color: var(--primary); font-weight: 700; background: #1a1a1a; }
        .day.empty { background: var(--bg-card); cursor: default; }

        .day-indicator { 
            position: absolute; bottom: 8px; right: 8px;
            background: var(--primary); color: black; 
            font-weight: bold; font-size: 0.65rem; 
            width: 20px; height: 20px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
        }

        /* --- FLOW EDITOR (CORREGIDO) --- */
        #view-flow {
            position: relative; /* Clave para que los hijos absolutos se posicionen respecto a esto */
            width: 100%;
            height: 100%;
        }
        
        #cy { 
            position: absolute; /* Clave para llenar el contenedor padre */
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            background: #050505; /* Fondo casi negro t√©cnico */
            z-index: 1;
        } 
        
        .flow-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 10; }
        .ctrl-btn { width: 32px; height: 32px; background: var(--bg-card); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); color: var(--text-main); font-size: 0.8rem; }
        .ctrl-btn:hover { background: var(--bg-hover); }

        .fab { position: absolute; bottom: 20px; right: 20px; background: var(--primary); color: black; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(255, 255, 255, 0.15); z-index: 20; font-size: 24px; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.05); }

        /* --- CHAT & MODALS --- */
        .chat-container-wrapper { background: #000; border: 1px solid var(--border); border-radius: var(--radius); flex: 1; display: flex; flex-direction: column; height: 100%; }
        .chat-header { background: var(--bg-card); padding: 15px; color: var(--text-main); border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; background: #050505; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; color: #e4e4e7; }
        .msg.bot { background: var(--bg-hover); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--primary); color: black; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        /* Modal Overlay */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        
        .sheet { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); width: 100%; max-width: 500px; max-height: 90vh; border-radius: var(--radius); padding: 25px; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }

        /* Inputs Globales */
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            background: var(--bg-body); 
            border: 1px solid var(--border); 
            border-radius: 6px;
            color: var(--text-main); 
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--text-muted); }
        label { display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

        /* --- WIZARD QR DARK --- */
        #setupWizard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .step-hidden { display: none !important; }
        .wizard-card { background: var(--bg-card); padding: 40px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; max-width: 400px; width: 90%; }
        .qr-container { background: white; border-radius: 8px; padding: 10px; margin: 20px auto; width: fit-content; }
        .w-btn { width: 100%; padding: 12px; background: var(--primary); color: black; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 6px; color: var(--text-main); font-size: 0.85rem; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        .toast i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Responsivo */
        @media(max-width: 768px) { 
            #mainApp { flex-direction: column; } 
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 4px 0 20px rgba(0,0,0,0.8); z-index: 200; } 
            .sidebar.active { transform: translateX(0); }
            .sheet { height: 100%; max-height: 100%; border-radius: 0; }
        }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <div id="toast-container"></div>

    <!-- WIZARD INICIAL -->
    <div id="setupWizard" class="step-hidden">
        <div id="stepLoading" class="wizard-card">
            <h2 style="color:var(--text-main); margin-top:0;">Iniciando Sistema</h2>
            <p style="color:var(--text-muted); font-size:0.9rem;">Estableciendo conexi√≥n segura...</p>
            <i class="fas fa-circle-notch fa-spin" style="font-size:2rem; color:var(--text-muted); margin-top:20px;"></i>
            
            <!-- BOT√ìN DE ESCAPE SI SE QUEDA PEGADO -->
            <div style="margin-top: 25px; border-top: 1px solid var(--border); padding-top: 20px;">
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">¬øTarda demasiado?</p>
                <button onclick="resetSession()" style="background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; width: 100%;">
                    <i class="fas fa-power-off"></i> Forzar Reinicio / Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <div id="stepQR" class="wizard-card step-hidden">
            <h2 style="color:var(--text-main); margin-top:0;">Vincular Dispositivo</h2>
            <p style="color:var(--text-muted); font-size:0.85rem;">Escanea el c√≥digo QR desde WhatsApp en tu m√≥vil.</p>
            <div class="qr-container"><canvas id="qrCanvas"></canvas></div>
            <p id="qrStatus" style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;">Generando c√≥digo...</p>
            <button class="w-btn" onclick="resetSession()" style="background:transparent; border:1px solid var(--border); color:var(--text-main);">Generar Nuevo C√≥digo</button>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="mainApp">

        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="brand">
                <i class="fas fa-cube"></i> CONTROL TOWER
                <button onclick="toggleMenu()" class="d-md-none" style="background:none; border:none; color:var(--text-main); margin-left:auto;">‚úï</button>
            </div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('flow', this)"><i class="fas fa-sitemap" style="width:20px"></i> Flujo Visual</div>
                <div class="menu-item" onclick="nav('activity', this)">
                    <i class="fas fa-chart-line" style="width:20px"></i> Monitor
                    <span id="notifyBadge" class="badge-count">0</span>
                </div>
                <div class="menu-item" onclick="nav('agenda', this)"><i class="far fa-calendar-alt" style="width:20px"></i> Agenda</div>
                <div class="menu-item" onclick="nav('contacts', this)"><i class="fas fa-users" style="width:20px"></i> Usuarios</div>
                <div class="menu-item" onclick="nav('settings', this)"><i class="fas fa-sliders-h" style="width:20px"></i> Ajustes</div>
                <div class="menu-item" onclick="nav('sim', this)"><i class="fas fa-terminal" style="width:20px"></i> Test Bot</div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-muted);">
                v2.0.0 Stable<br>Server Status: <span style="color:var(--success)">‚óè Online</span>
            </div>
        </div>

        <!-- CONTENIDO -->
        <div class="content">
            <div class="mobile-header">
                <button onclick="toggleMenu()" style="background:none; border:none; color:white; font-size:1.2rem;">‚ò∞</button>
                <span id="pageTitle" style="font-size:0.9rem; font-weight:600;">FLUJO VISUAL</span>
                <div style="width:30px"></div>
            </div>

            <!-- VISTA: FLUJO (EDITOR) -->
            <div id="view-flow" class="view active">
                <div id="cy"></div> <!-- AHORA POSICIONADO ABSOLUTAMENTE -->
                <div class="flow-controls">
                    <div class="ctrl-btn" onclick="cy.zoom(cy.zoom()+0.2)"><i class="fas fa-plus"></i></div>
                    <div class="ctrl-btn" onclick="cy.zoom(cy.zoom()-0.2)"><i class="fas fa-minus"></i></div>
                    <div class="ctrl-btn" onclick="cy.fit()"><i class="fas fa-expand"></i></div>
                </div>
                <div class="fab" onclick="newStep()">+</div>
            </div>

            <!-- VISTA: MONITOR -->
            <div id="view-activity" class="view view-padding">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0; font-size:1rem; color:var(--text-main)">Actividad Reciente</h3>
                        <span id="crmStatusBadge" class="status-badge closed">‚óè OFFLINE</span>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="act-table">
                            <thead><tr><th>Cliente</th><th>Datos</th><th>Acciones</th></tr></thead>
                            <tbody id="activityBody"></tbody>
                        </table>
                    </div>
                </div>
                <button onclick="loadActivity(); showToast('Actualizando...')" style="width:100%; padding:12px; background:transparent; color:var(--text-muted); border:1px solid var(--border); border-radius:6px; font-weight:500; cursor:pointer; font-size:0.8rem; transition:0.2s;">
                    <i class="fas fa-sync-alt"></i> Forzar Actualizaci√≥n
                </button>
            </div>

            <!-- VISTA: AGENDA -->
            <div id="view-agenda" class="view view-padding">
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="monthDisplay"></h3>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid">
                        <div class="weekday">Dom</div><div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mi√©</div>
                        <div class="weekday">Jue</div><div class="weekday">Vie</div><div class="weekday">S√°b</div>
                    </div>
                    <div id="calendarDays" class="calendar-grid" style="flex: 1; border-top: none; border-radius: 0 0 8px 8px; border-color: var(--border);"></div>
                </div>
            </div>

            <!-- VISTA: CONTACTOS -->
            <div id="view-contacts" class="view view-padding">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; font-size:1rem;">Base de Usuarios</h3>
                        <button onclick="openContactModal()" style="background:var(--primary); color:black; border:none; width:30px; height:30px; border-radius:4px; font-size:1rem; cursor:pointer; font-weight:bold;">+</button>
                    </div>
                    <input type="text" placeholder="Filtrar por nombre o tel√©fono..." oninput="delayedFilter(this.value)">
                    <div id="contactsList" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- VISTA: SIMULADOR -->
            <div id="view-sim" class="view view-padding">
                <div class="chat-container-wrapper">
                    <div class="chat-header">
                        <span>Terminal / Simulador</span>
                        <i class="fas fa-eraser" onclick="restartSim()" style="cursor:pointer; opacity:0.7;" title="Limpiar"></i>
                    </div>
                    <div class="chat-msgs" id="simMsgs"></div>
                    <div style="padding: 15px; background: var(--bg-card); display: flex; gap: 10px; align-items: center; border-top: 1px solid var(--border);">
                        <input type="text" id="simInput" placeholder="Escribe comando o mensaje..." style="margin:0; flex:1;" onkeypress="if(event.key==='Enter') sendSim()">
                        <button onclick="sendSim()" style="background:var(--primary); color:black; border:none; border-radius:4px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- VISTA: SETTINGS -->
            <div id="view-settings" class="view view-padding">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <h3 style="margin-top:0; font-size:1rem; margin-bottom:20px;">Configuraci√≥n Global</h3>
                    
                    <div style="padding:15px; border:1px solid var(--border); border-radius:6px; margin-bottom:20px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0; color:var(--text-main);">
                            <input type="checkbox" id="schedActive" style="width:16px; height:16px; margin:0;"> Restringir Horario de Respuesta
                        </label>
                        <p style="margin:5px 0 0 26px; font-size:0.75rem; color:var(--text-muted);">El bot responder√° con un mensaje de ausencia fuera del horario establecido.</p>
                    </div>

                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <div style="flex:1"><label>Apertura</label><input type="time" id="schedStart"></div>
                        <div style="flex:1"><label>Cierre</label><input type="time" id="schedEnd"></div>
                    </div>
                    
                    <label>Mensaje de Ausencia</label>
                    <textarea id="schedMsg" placeholder="Ej: Actualmente no estamos disponibles..." rows="3"></textarea>
                    
                    <button onclick="saveSettings()" style="width:100%; padding:12px; background:var(--primary); color:black; border:none; border-radius:6px; font-weight:600; margin-top:10px; cursor:pointer;">Guardar Cambios</button>
                </div>
            </div>

        </div> <!-- Fin Content -->
    </div> <!-- Fin MainApp -->

    <!-- MODALES -->
    <!-- Modal Agenda -->
    <div class="modal" id="dayModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:15px;">
                <div><h3 id="modalDateTitle" style="margin:0; font-size:1rem;">Eventos</h3><small id="modalDateSubtitle" style="color:var(--text-muted);"></small></div>
                <button onclick="closeDayModal()" style="background:none; border:none; font-size:1.2rem; color:var(--text-muted); cursor:pointer;">‚úï</button>
            </div>
            <div style="flex:1; overflow-y: auto; display:flex; flex-direction:column; gap:10px;">
                <div id="modalApptList"></div>
                <button id="btnAddEvent" onclick="showEventForm()" style="width:100%; padding:10px; background:var(--bg-hover); color:var(--text-main); border:1px dashed var(--border); border-radius:6px; font-size:0.85rem; cursor:pointer;">+ Nuevo Evento</button>
                
                <div id="eventForm" style="display:none; background:var(--bg-body); padding:15px; border-radius:6px; border:1px solid var(--border); margin-top:10px;">
                    <h4 style="margin:0 0 10px 0; font-size:0.9rem;">Detalles del Evento</h4>
                    <input type="hidden" id="evtOldTime">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>Hora</label><input type="time" id="evtTime"></div>
                        <div style="flex:2"><label>Tel√©fono</label><input type="text" id="evtPhone" placeholder="Opcional"></div>
                    </div>
                    <label>Nombre / T√≠tulo</label><input type="text" id="evtName">
                    <label>Notas</label><textarea id="evtNote" rows="2"></textarea>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button onclick="saveEvent()" style="flex:1; padding:8px; background:var(--primary); color:black; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Guardar</button>
                        <button onclick="hideEventForm()" style="padding:8px; background:transparent; border:1px solid var(--border); color:var(--text-muted); border-radius:4px; cursor:pointer;">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Contacto -->
    <div class="modal" id="contactModal">
        <div class="sheet" style="height:auto;">
            <h3 style="margin-top:0; font-size:1rem;">A√±adir Usuario Manual</h3>
            <label>Nombre / Alias</label><input type="text" id="newContName">
            <label>WhatsApp (con c√≥digo pa√≠s)</label><input type="tel" id="newContPhone" placeholder="Ej: 521...">
            
            <div style="background:var(--bg-body); padding:10px; border-radius:6px; margin:10px 0; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.85rem;">Bot Activo</span>
                <input type="checkbox" id="newContEnable" checked>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="saveNewContact()" style="flex:1; padding:10px; background:var(--primary); color:black; border:none; border-radius:4px; font-weight:600; cursor:pointer;">A√±adir</button>
                <button onclick="document.getElementById('contactModal').classList.remove('active')" style="padding:10px; background:transparent; border:1px solid var(--border); color:var(--text-muted); border-radius:4px; cursor:pointer;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editor -->
    <div class="modal" id="editorModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:15px;">
                <h3 style="margin:0; font-size:1rem;">Propiedades del Nodo</h3>
                <button onclick="closeEditor()" style="background:none; border:none; font-size:1.2rem; color:var(--text-muted); cursor:pointer;">‚úï</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding-right:5px;">
                <input type="hidden" id="stId">
                <label>Tipo de Interacci√≥n</label>
                <select id="stType" onchange="renderFields()">
                    <option value="menu">Men√∫ Interactivo</option>
                    <option value="filtro">Filtro / Decisi√≥n</option>
                    <option value="input">Solicitar Dato</option>
                    <option value="message">Enviar Mensaje</option>
                    <option value="cita">M√≥dulo Citas</option>
                </select>
                
                <div id="wrapper-msg" style="margin-top:15px;">
                    <label>Contenido del Mensaje</label>
                    <textarea id="stMsg" rows="4" placeholder="Escribe lo que dir√° el bot..."></textarea>
                </div>
                
                <div id="wrapper-media" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label>Adjuntos</label>
                        <span id="imgCount" style="font-size:0.7rem; color:var(--text-muted);">0 archivos</span>
                    </div>
                    <div id="galleryContainer" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;"></div>
                    <label class="upload-btn" style="display:block; text-align:center; padding:8px; border:1px dashed var(--border); border-radius:4px; font-size:0.8rem; cursor:pointer; color:var(--text-muted);">
                        + Subir Imagen
                        <input type="file" id="imgUpload" accept="image/*" multiple style="display:none" onchange="uploadImages(this)">
                    </label>
                </div>
                
                <div id="dynFields" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;"></div>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="saveStep()" style="flex:1; padding:12px; background:var(--primary); color:black; border:none; border-radius:4px; font-weight:600; cursor:pointer;">Guardar</button>
                <button onclick="delStep()" style="padding:12px; background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid var(--danger); border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <!-- SCRIPT L√ìGICO -->
    <script>
        // Configuraci√≥n de la URL Base de la API
        // Esto corrige el error en entornos donde no hay un origen claro (blobs, iframes locales)
        const API_BASE = (() => {
            const { protocol } = window.location;
            // Si estamos en un blob, archivo local o entorno sin origen standard
            if (protocol === 'file:' || protocol === 'blob:' || protocol === 'data:') {
                return 'http://localhost:3000';
            }
            return ''; // Rutas relativas por defecto para producci√≥n
        })();

        // Variables mejoradas para control de polling
        let pollingInterval = null;
        let activityInterval = null;
        let lastQr = '';
        let isConnected = false;
        let isPollingActive = false;

        // Funci√≥n para limpiar todos los intervals
        function cleanupAllIntervals() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            if (activityInterval) {
                clearInterval(activityInterval);
                activityInterval = null;
            }
            isPollingActive = false;
        }

        window.onload = async () => {
            document.getElementById('setupWizard').classList.remove('step-hidden');
            startPolling();
            loadAll();
            
            // Intervalo optimizado para carga de actividad
            activityInterval = setInterval(() => {
                // Solo cargar actividad si la vista est√° activa
                if (document.getElementById('view-activity').classList.contains('active')) {
                    loadActivity();
                }
            }, 8000);
        };

        function startPolling() {
            // Limpiar intervalo existente
            cleanupAllIntervals();
            isPollingActive = true;
            
            pollingInterval = setInterval(async () => {
                // Verificar si el polling sigue activo
                if (!isPollingActive) {
                    clearInterval(pollingInterval);
                    return;
                }
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const res = await fetch(`${API_BASE}/api/status`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    const data = await res.json();
                    
                    if (data.status === 'connected') {
                        isConnected = true;
                        cleanupAllIntervals(); // Detener polling una vez conectado
                        document.getElementById('setupWizard').classList.add('step-hidden');
                        
                        // Notificar y actualizar interfaz
                        showToast('Conectado exitosamente');
                        updateStatusUI();
                    } else if (data.qr) {
                        document.getElementById('stepLoading').classList.add('step-hidden');
                        document.getElementById('stepQR').classList.remove('step-hidden');
                        
                        if (data.qr !== lastQr) { 
                            lastQr = data.qr; 
                            renderQR(data.qr); 
                            document.getElementById('qrStatus').innerText = "Escanea ahora"; 
                        }
                    } else {
                        if (data.status === 'disconnected') {
                            // Llamada sin esperar respuesta para no bloquear
                            fetch(`${API_BASE}/api/auth/init`, { 
                                method: 'POST' 
                            }).catch(e => console.warn("Init error:", e));
                        }
                        document.getElementById('stepLoading').classList.remove('step-hidden');
                        document.getElementById('stepQR').classList.add('step-hidden');
                    }
                } catch (e) { 
                    if (e.name !== 'AbortError') {
                        console.warn("Polling error (no cr√≠tico):", e);
                    }
                    // No hacer nada en caso de error - el intervalo continuar√°
                }
            }, 2000);
        }
        function renderQR(qrString) { new QRious({ element: document.getElementById('qrCanvas'), value: qrString, size: 220, level: 'H' }); }
        async function resetSession() { if(!confirm("¬øReiniciar conexi√≥n?")) return; await fetch(`${API_BASE}/api/logout`, { method: 'POST' }); location.reload(); }

        let flow={}, users=[];
        let simPhone = '5218991234567'; 
        let simState={ step:'BIENVENIDA', history:{} };
        let cy = null;
        let currentRefDate = new Date();
        let wakeLock = null;
        const emojis = ['0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü'];
        const delayedFilter = debounce(filterContacts, 300);

        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }
        
        function nav(v, btn) {
            // Gesti√≥n de clases activas
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            if (btn) btn.classList.add('active');
            
            // T√≠tulos
            const titles = { flow: 'FLUJO VISUAL', activity: 'MONITOR EN VIVO', agenda: 'CALENDARIO', contacts: 'USUARIOS', settings: 'AJUSTES', sim: 'TEST BOT' };
            document.getElementById('pageTitle').innerText = titles[v] || v.toUpperCase();
            document.getElementById('sidebar').classList.remove('active');
            
            // üõë LIMPIEZA DE MEMORIA AL CAMBIAR DE PESTA√ëA üõë
            if (v !== 'flow' && cy) {
                try { cy.destroy(); cy = null; } catch(e){}
            }
            
            // Renderizado espec√≠fico
            if (v === 'flow') setTimeout(renderFlow, 50); // Peque√±o delay para que la UI respire
            if (v === 'activity') loadActivity();
            if (v === 'agenda') renderCalendar();
            if (v === 'sim') scrollToBottomSim(); 
            if (v === 'contacts') renderContacts();
        }

        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') wakeLock = await navigator.wakeLock.request('screen'); });

        function showToast(msg, type='success') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> <span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
        }

        async function loadAll() {
            try {
                flow = await (await fetch(`${API_BASE}/api/flow`)).json();
                renderFlow();
                const set = await (await fetch(`${API_BASE}/api/settings`)).json();
                if(set.schedule) {
                    document.getElementById('schedActive').checked = set.schedule.active;
                    document.getElementById('schedStart').value = set.schedule.start;
                    document.getElementById('schedEnd').value = set.schedule.end;
                    document.getElementById('schedMsg').value = set.schedule.offline_message;
                }
            } catch(e) {}
        }

        async function loadActivity() {
            try {
                flow = await (await fetch(`${API_BASE}/api/flow`)).json();
                users = await (await fetch(`${API_BASE}/api/users`)).json();
                updateStatusUI();
                const tb = document.getElementById('activityBody'); tb.innerHTML = ''; 
                let allToShow = users.filter(u => u.phone !== 'TEST_SIMULADOR').sort((a, b) => new Date(b.last_active||0) - new Date(a.last_active||0));
                
                if (allToShow.length === 0) tb.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted); font-size:0.85rem;">Esperando actividad...</td></tr>';
                else {
                    allToShow.forEach(u => {
                        const s = flow[u.current_step] || { type: 'unknown' };
                        let actionsHtml = `<div style="margin-bottom:5px;"><span style="font-size:0.7rem; background:var(--bg-body); padding:2px 6px; border:1px solid var(--border); border-radius:4px; color:var(--text-muted);">${u.current_step}</span></div>`;
                        if (s.type === 'filtro' && s.options) {
                            s.options.forEach(opt => {
                                // Estilo minimalista para botones
                                actionsHtml += `<button class="admin-btn" onclick="crmAction('${u.phone}', '${opt.next_step}')">${opt.label}</button>`;
                            });
                        }
                        
                        let dataHtml = '';
                        if(u.history) Object.entries(u.history).forEach(([k,v]) => dataHtml += `<div style="font-size:0.75rem; color:var(--text-muted);">${k}: <span style="color:var(--text-main)">${v}</span></div>`);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><div style="font-weight:500;">${u.phone}</div><small style="color:var(--text-muted); font-size:0.7rem;">${new Date(u.last_active).toLocaleTimeString()}</small></td>
                        <td>${dataHtml || '<span style="color:var(--text-muted)">-</span>'}</td>
                        <td>${actionsHtml}</td>`;
                        tb.appendChild(row);
                    });
                }
            } catch(e) { console.error(e); }
        }

        function updateStatusUI() {
            // Placeholder para estado del negocio
            const badge = document.getElementById('crmStatusBadge');
            badge.className = 'status-badge open'; 
            badge.innerHTML = '‚óè ONLINE';
        }

        async function crmAction(phone, nextStep) { if(!confirm(`¬øMover a ${nextStep}?`)) return; await fetch(`${API_BASE}/api/crm/execute`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, stepId: nextStep }) }); loadActivity(); }

        function renderFlow() {
            // 1. Gesti√≥n de Memoria y Estado de la Vista
            let savedZoom = null;
            let savedPan = null;

            if (cy && typeof cy.destroy === 'function') {
                try {
                    savedZoom = cy.zoom();
                    savedPan = cy.pan();
                } catch(e) {}
                cy.destroy(); // Limpiamos la instancia anterior para liberar RAM
                cy = null;
            }

            if (!flow || Object.keys(flow).length === 0) return;

            // 2. Mapa de Colores (M√°s limpio y r√°pido que m√∫ltiples if/else)
            const nodeColors = {
                'menu': '#2563eb',    // Azul
                'filtro': '#7c3aed',  // Violeta
                'input': '#d97706',   // Naranja
                'message': '#059669', // Verde
                'cita': '#db2777',    // Rosa
                'default': '#334155'  // Gris
            };

            // 3. Construcci√≥n de Elementos
            let elements = [];
            
            Object.keys(flow).forEach(k => {
                const s = flow[k];
                if (!s) return;

                const color = nodeColors[s.type] || nodeColors['default'];
                
                // Nodo
                elements.push({ 
                    data: { id: k, label: k, color: color } 
                });

                // Conexiones (Edges)
                if (s.options && Array.isArray(s.options)) {
                    s.options.forEach(o => {
                        if (o.next_step && flow[o.next_step]) {
                            elements.push({ 
                                data: { source: k, target: o.next_step, label: o.label || '' } 
                            });
                        }
                    });
                } else if (s.next_step && flow[s.next_step]) {
                    elements.push({ 
                        data: { source: k, target: s.next_step, label: '' } 
                    });
                }
            });

            // 4. Inicializaci√≥n de Cytoscape Optimizado
            try {
                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,

                    // --- OPTIMIZACIONES DE RENDIMIENTO ---
                    textureOnViewport: true, // Dibuja una 'foto' al mover, elimina el lag
                    pixelRatio: 1,           // Baja la resoluci√≥n interna para velocidad
                    motionBlur: false,       // Desactiva efectos costosos
                    // -------------------------------------

                    // --- REGLAS DE INTERACCI√ìN ---
                    autolock: true,          // üîí NODOS FIJOS: No se pueden arrastrar
                    autoungrabify: true,
                    boxSelectionEnabled: false,
                    wheelSensitivity: 0.1,   // Zoom m√°s suave

                    style: [
                        // NODOS
                        { selector: 'node', style: {
                            'background-color': '#ffffff', // Fondo blanco para contraste
                            'border-width': 2,
                            'border-color': 'data(color)', // Borde del color del tipo
                            'label': 'data(label)',
                            'color': '#1e293b', // Texto oscuro
                            'shape': 'round-rectangle',
                            'width': 'label',
                            'height': '40px',
                            'padding': '12px',
                            'font-family': 'Inter, sans-serif',
                            'font-size': '12px',
                            'font-weight': '700',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'text-transform': 'uppercase',
                            'shadow-blur': 12,
                            'shadow-color': 'data(color)', // Sombra del color del tipo
                            'shadow-opacity': 0.15,
                            'shadow-offset-y': 2
                        }},
                        // L√çNEAS (Edges)
                        { selector: 'edge', style: {
                            'width': 2,
                            'line-color': '#dc2626',         // üî¥ L√çNEAS ROJAS (Solicitado)
                            'target-arrow-color': '#dc2626',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'taxi',           // 'taxi' o 'bezier' son los m√°s r√°pidos
                            'taxi-direction': 'rightward',   // Fuerza l√≠neas rectas tipo tuber√≠a
                            'arrow-scale': 1.2,
                            'label': 'data(label)',
                            'font-size': '10px',
                            'color': '#ef4444',
                            'text-background-opacity': 1,
                            'text-background-color': '#ffffff',
                            'text-background-padding': '3px',
                            'text-background-shape': 'roundrectangle',
                            'text-rotation': 'autorotate'
                        }},
                        // ESTADO SELECCIONADO
                        { selector: 'node:selected', style: {
                            'border-width': 4,
                            'border-color': '#000000',
                            'shadow-opacity': 0.4
                        }},
                        // ESTADO FADED (Cuando seleccionas otro nodo)
                        { selector: '.faded', style: {
                            'opacity': 0.1,
                            'label': ''
                        }},
                        { selector: '.highlighted', style: {
                            'opacity': 1,
                            'z-index': 999
                        }}
                    ],

                    layout: {
                        name: 'klay',
                        nodeDimensionsIncludeLabels: true, // Importante para que no se encimen
                        fit: true,
                        padding: 20,
                        animate: false, 

                        klay: {
                            // Cambiamos a 'LONGEST_PATH' porque es m√°s robusto y evita el apilamiento
                            nodeLayering: 'LONGEST_PATH', 
                            
                            direction: 'RIGHT',
                            spacing: 100,           // Aumentado: M√°s espacio entre nodos
                            intCoordinates: true,   // Ayuda a la precisi√≥n
                            compactComponents: false, // Evita agrupar islas desconectadas
                            
                            // Configuraci√≥n de l√≠neas
                            edgeRouting: 'ORTHOGONAL', 
                            cycleBreaking: 'GREEDY',
                            fixedAlignment: 'BALANCED'
                        }
                    }
                });

                // 6. Restaurar Vista (Anti-Salto)
                if (savedZoom && savedPan) {
                    cy.viewport({ zoom: savedZoom, pan: savedPan });
                }

                // 7. Eventos de Interacci√≥n (Highlighting)
                cy.on('tap', 'node', function(evt){
                    const node = evt.target;
                    // Limpiar previos
                    cy.elements().removeClass('highlighted faded');
                    // Calcular vecindario (padres e hijos directos)
                    const neighborhood = node.predecessors().union(node.successors()).union(node);
                    // Aplicar clases
                    cy.elements().not(neighborhood).addClass('faded');
                    neighborhood.addClass('highlighted');
                });

                cy.on('tap', function(evt){
                    if(evt.target === cy){ // Click en el fondo vac√≠o
                        cy.elements().removeClass('highlighted faded');
                    }
                });

                cy.on('dbltap', 'node', function(evt){
                    edit(evt.target.id());
                });

            } catch(e) { console.error("Error renderizando grafo:", e); }
        }

        // --- EDITOR (L√≥gica intacta) ---
        let currentMediaList = [];
        function edit(id) {
            const d = flow[id]; document.getElementById('stId').value = id; document.getElementById('stType').value = d.type; document.getElementById('stMsg').value = d.message || '';
            currentMediaList = Array.isArray(d.media) ? d.media : (d.media ? [d.media] : []);
            renderGallery(); renderFields(); document.getElementById('editorModal').classList.add('active');
        }
        function closeEditor() { document.getElementById('editorModal').classList.remove('active'); }
        
        function renderFields() {
            const type = document.getElementById('stType').value;
            const con = document.getElementById('dynFields');
            const id = document.getElementById('stId').value;
            const d = flow[id] || {};
            let html = '';
            
            const keywordsVal = (d.keywords || []).join(', ');
            html += `<label>Palabras Clave</label><input type="text" id="stKeywords" value="${keywordsVal}" placeholder="Ej: hola, menu, inicio">`;

            const getOpts = (sel) => { let s='<option value="">-- Seleccionar --</option>'; Object.keys(flow).forEach(k=>s+=`<option value="${k}" ${k===sel?'selected':''}>${k}</option>`); return s; };
            
            if(type==='menu' || type==='filtro') {
                html += `<div id="optList" style="margin-top:10px;"><label>Opciones</label>`;
                (d.options||[]).forEach(o => {
                    html += `<div class="row" style="display:flex; gap:5px; margin-bottom:5px;"><input class="o-lbl" value="${o.label}" placeholder="Texto Bot√≥n"><select class="o-nxt">${getOpts(o.next_step)}</select><button onclick="this.parentElement.remove()" style="color:var(--danger); background:transparent; border:none; cursor:pointer;">‚úï</button></div>`;
                });
                html += `</div><button onclick="addOpt()" style="width:100%; padding:8px; background:var(--bg-hover); border:1px dashed var(--border); color:var(--text-muted); cursor:pointer; margin-top:5px; border-radius:4px; font-size:0.8rem;">+ Agregar Opci√≥n</button>`;
                if(type==='filtro') html += `<label style="margin-top:10px">Guardar Estado en Variable</label><input id="stVar" value="${d.save_var||'status'}" placeholder="ej: status">`;
            } else {
                html += `<label>Siguiente Paso</label><select id="stNxt">${getOpts(d.next_step)}</select>`;
                if(type==='input') html += `<label style="margin-top:10px">Guardar Respuesta en Variable</label><input id="stVar" value="${d.save_var||''}" placeholder="ej: nombreCliente">`;
            }
            con.innerHTML = html;
        }

        function addOpt() {
            const div = document.createElement('div'); div.className='row'; div.style.cssText="display:flex; gap:5px; margin-bottom:5px;";
            let s='<option value="">-- Seleccionar --</option>'; Object.keys(flow).forEach(k=>s+=`<option value="${k}">${k}</option>`);
            div.innerHTML=`<input class="o-lbl" placeholder="Texto Bot√≥n"><select class="o-nxt">${s}</select><button onclick="this.parentElement.remove()" style="color:var(--danger); background:transparent; border:none; cursor:pointer;">‚úï</button>`;
            document.getElementById('optList').appendChild(div);
        }
        
        async function saveStep() {
            const id = document.getElementById('stId').value;
            const type = document.getElementById('stType').value;
            let data = { type, message: document.getElementById('stMsg').value, media: currentMediaList };
            const kw = document.getElementById('stKeywords'); if(kw) data.keywords = kw.value.split(',').map(s=>s.trim()).filter(Boolean);
            
            if(type==='menu' || type==='filtro') {
                data.options = [];
                document.querySelectorAll('#optList .row').forEach((r,i) => {
                     data.options.push({ trigger: (i+1).toString(), label: r.querySelector('.o-lbl').value, next_step: r.querySelector('.o-nxt').value });
                });
                if(type==='filtro') data.save_var = document.getElementById('stVar').value;
            } else {
                if(document.getElementById('stNxt')) data.next_step = document.getElementById('stNxt').value;
                if(type==='input') data.save_var = document.getElementById('stVar').value;
            }
            await fetch(`${API_BASE}/api/flow/step`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({stepId:id, stepData:data}) });
            loadAll(); closeEditor(); showToast('Guardado');
        }

        function newStep() { const id = prompt("Nombre del Nuevo Paso (ej: MENU_VENTAS):"); if(id) { flow[id.toUpperCase()]={type:'menu'}; renderFlow(); setTimeout(()=>edit(id.toUpperCase()),200); } }
        async function delStep() { const id=document.getElementById('stId').value; if(confirm('¬øEliminar este paso?')) { await fetch(`${API_BASE}/api/flow/step/`+id, {method:'DELETE'}); loadAll(); closeEditor(); showToast('Eliminado'); } }

        function renderGallery() {
            const c = document.getElementById('galleryContainer'); c.innerHTML='';
            currentMediaList.forEach((u,i) => c.innerHTML += `<div style="position:relative; width:60px; height:60px;"><img src="${u}" style="width:100%; height:100%; border-radius:4px; object-fit:cover; border:1px solid var(--border);"><button onclick="currentMediaList.splice(${i},1); renderGallery()" style="position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; font-size:10px; border:none; cursor:pointer;">‚úï</button></div>`);
            document.getElementById('imgCount').innerText = currentMediaList.length + " archivos";
        }
        async function uploadImages(inp) {
            if(!inp.files.length) return;
            const fd = new FormData(); for(let f of inp.files) fd.append('images', f);
            const res = await (await fetch(`${API_BASE}/api/upload`, {method:'POST', body:fd})).json();
            if(res.urls) { currentMediaList.push(...res.urls); renderGallery(); }
        }

        // --- AGENDA & CALENDARIO ---
        async function renderCalendar() {
            const now = currentRefDate;
            const m = now.getMonth(), y = now.getFullYear();
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const months = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
            document.getElementById('monthDisplay').innerText = `${months[m]} ${y}`;
            const g = document.getElementById('calendarDays'); g.innerHTML = '';
            
            let appts = {}; try { appts = await (await fetch(`${API_BASE}/api/agenda`)).json(); } catch(e){}

            for(let i=0; i<firstDay; i++) g.innerHTML += `<div class="day empty"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                const k = `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                const count = (appts[k]||[]).length;
                const isToday = new Date().toDateString() === new Date(y,m,i).toDateString();
                g.innerHTML += `<div class="day ${isToday?'today':''}" onclick="openDayModal('${k}', [])">${i} ${count?`<span class="day-indicator">${count}</span>`:''}</div>`;
            }
        }
        function changeMonth(d) { currentRefDate.setMonth(currentRefDate.getMonth()+d); renderCalendar(); }
        
        function openDayModal(dateStr, _) {
            document.getElementById('modalDateTitle').innerText = dateStr;
            renderEventList(dateStr);
            document.getElementById('dayModal').classList.add('active');
        }
        function closeDayModal() { document.getElementById('dayModal').classList.remove('active'); renderCalendar(); }

        async function renderEventList(dateKey) {
            const list = document.getElementById('modalApptList'); list.innerHTML = 'Cargando...';
            const allAppts = await (await fetch(`${API_BASE}/api/agenda`)).json();
            const appts = allAppts[dateKey] || [];
            list.innerHTML = '';
            if(!appts.length) list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic; font-size:0.85rem;">No hay eventos para este d√≠a.</div>';
            
            appts.sort((a,b)=>a.time.localeCompare(b.time)).forEach(c => {
                const row = document.createElement('div');
                row.style.cssText = "background:var(--bg-body); border:1px solid var(--border); border-radius:6px; padding:10px; display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;";
                row.innerHTML = `
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-family:monospace; color:var(--primary); background:var(--bg-card); padding:2px 4px; border-radius:4px; font-size:0.8rem;">${c.time}</span>
                            <span style="font-weight:600; font-size:0.9rem;">${c.name}</span>
                        </div>
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">${c.phone||''}</div>
                        ${c.note ? `<div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px; font-style:italic;">"${c.note}"</div>` : ''}
                    </div>
                    <button onclick="deleteAppt('${dateKey}', '${c.time}')" style="background:transparent; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(row);
            });
            // Guardamos fecha actual para el form
            document.getElementById('evtOldTime').dataset.date = dateKey; 
        }

        function showEventForm() { document.getElementById('eventForm').style.display='block'; document.getElementById('btnAddEvent').style.display='none'; }
        function hideEventForm() { document.getElementById('eventForm').style.display='none'; document.getElementById('btnAddEvent').style.display='block'; }

        async function saveEvent() {
            const date = document.getElementById('evtOldTime').dataset.date;
            const time = document.getElementById('evtTime').value;
            const name = document.getElementById('evtName').value;
            const phone = document.getElementById('evtPhone').value;
            const note = document.getElementById('evtNote').value;
            if(!time || !name) return showToast('Falta hora o nombre', 'error');
            
            await fetch(`${API_BASE}/api/agenda/book`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({date, time, name, phone, note}) });
            hideEventForm(); renderEventList(date); showToast('Evento Guardado');
        }
        async function deleteAppt(date, time) {
            if(!confirm('¬øEliminar?')) return;
            await fetch(`${API_BASE}/api/agenda/delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({date, time}) });
            renderEventList(date);
        }

        // --- CONTACTOS (OPTIMIZADO) ---
        async function renderContacts() {
            try {
                // 1. Obtener datos
                const list = await (await fetch(`${API_BASE}/api/contacts`)).json();
                const c = document.getElementById('contactsList');
                
                // 2. Construir HTML en una variable (Buffer) para no congelar la UI
                let htmlBuffer = '';
                
                list.forEach(u => {
                    htmlBuffer += `
                    <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border); align-items:center;" class="toggle-row">
                        <div>
                            <b style="color:var(--text-main); font-size:0.9rem;">${u.name||u.phone}</b>
                            <div style="color:var(--text-muted); font-size:0.75rem;">${u.phone}</div>
                        </div>
                        <label class="switch" style="position:relative; display:inline-block; width:36px; height:20px;">
                            <input type="checkbox" ${u.bot_enabled?'checked':''} onchange="toggleUser('${u.phone}', this.checked)" style="opacity:0; width:0; height:0;">
                            <span class="slider" style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:var(--bg-hover); transition:.4s; border-radius:34px;"></span>
                            <span class="slider-ball" style="position:absolute; content:''; height:14px; width:14px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%;"></span>
                        </label>
                    </div>`;
                });

                // 3. Actualizar el DOM una sola vez
                c.innerHTML = htmlBuffer;

                // 4. Inyectar estilos del switch solo si no existen
                if (!document.getElementById('toggle-style')) {
                    const style = document.createElement('style');
                    style.id = 'toggle-style';
                    style.innerHTML = `input:checked + .slider { background-color: var(--success); } input:checked + .slider + .slider-ball { transform: translateX(16px); }`;
                    document.head.appendChild(style);
                }
            } catch (e) {
                console.error("Error cargando contactos:", e);
            }
        }
        function filterContacts(v) { const rows = document.querySelectorAll('.toggle-row'); rows.forEach(r => { r.style.display = r.innerText.toLowerCase().includes(v.toLowerCase()) ? 'flex' : 'none'; }); }
        async function toggleUser(phone, en) { await fetch(`${API_BASE}/api/contacts/toggle`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone, enable:en})}); showToast('Bot ' + (en?'Activado':'Desactivado')); }
        
        function openContactModal() { document.getElementById('contactModal').classList.add('active'); }
        async function saveNewContact() {
            const name = document.getElementById('newContName').value;
            const phone = document.getElementById('newContPhone').value;
            const enable = document.getElementById('newContEnable').checked;
            if(!phone) return;
            await fetch(`${API_BASE}/api/contacts/add`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, phone, enable})});
            document.getElementById('contactModal').classList.remove('active');
            renderContacts();
        }

        // --- SIMULADOR ---
        function scrollToBottomSim() { const c = document.getElementById('simMsgs'); if(c) c.scrollTop = c.scrollHeight; }
        function sendSim() {
            const t = document.getElementById('simInput'); const txt = t.value; if(!txt) return;
            addMsg(txt, true); t.value=''; 
            simState.history['last_input'] = txt; // Mock save
            fetch(`${API_BASE}/api/crm/execute`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:simPhone, stepId:simState.step})}); // Just to trigger log
            
            // Simulaci√≥n visual r√°pida
            setTimeout(() => {
                const step = flow[simState.step] || {};
                if(step.type === 'menu' || step.type === 'input') {
                    // L√≥gica real est√° en server, esto es solo UI feedback
                    addMsg("Procesando...", false); 
                }
            }, 600);
        }
        function addMsg(txt, usr) {
            const d=document.createElement('div'); d.className=`msg ${usr?'user':'bot'}`; 
            d.innerHTML=txt; document.getElementById('simMsgs').appendChild(d); scrollToBottomSim();
        }
        function restartSim() { document.getElementById('simMsgs').innerHTML=''; simState={step:'BIENVENIDA', history:{}}; showToast('Terminal Limpia'); }

        // --- SETTINGS ---
        async function saveSettings() {
            const s = { active: document.getElementById('schedActive').checked, start: document.getElementById('schedStart').value, end: document.getElementById('schedEnd').value, offline_message: document.getElementById('schedMsg').value };
            await fetch(`${API_BASE}/api/settings`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({schedule:s})});
            showToast('Configuraci√≥n Guardada');
        }

    </script>
</body>
</html>
