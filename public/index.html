<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM - Flow Studio</title>
    
    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Librer√≠as JS -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- ESTILOS --- */
        :root { 
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --bg-card: #1e293b; --bg-input: #020617;
            --border: #334155; --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Inter', sans-serif; margin: 0; height: 100dvh; background: var(--bg-body); color: var(--text-main); overflow: hidden; font-size: 14px; }

        /* Layout */
        #mainApp { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        #mainApp.visible { opacity: 1; pointer-events: all; }

        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 200; transition: transform 0.3s; flex-shrink: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }
        
        .brand { height: 64px; padding: 0 24px; display: flex; align-items: center; gap: 12px; font-weight: 700; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .menu { padding: 20px 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .menu-item { padding: 12px 16px; border-radius: 8px; font-weight: 500; color: var(--text-muted); display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { background: var(--border); color: var(--text-main); }
        .menu-item.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; font-weight: 600; }
        
        #installAppBtn { display: none; background: rgba(16, 185, 129, 0.1); color: #34d399; margin-top: 10px; border: 1px dashed rgba(16, 185, 129, 0.3); }

        .content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
        .mobile-header { display: none; background: var(--bg-sidebar); height: 60px; padding: 0 20px; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        
        .view { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; }
        .view.active { display: flex; animation: fadeIn 0.3s ease; }
        .view-padding { padding: 30px; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 20px; }
        .act-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .act-table th, .act-table td { padding: 14px; border-bottom: 1px solid var(--border); text-align: left; color: var(--text-muted); }
        .act-table tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
        .status-badge.connected { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .status-badge.disconnected { background: rgba(239, 68, 68, 0.15); color: #f87171; }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; text-align: center; font-size: 1rem;}
        .admin-btn { padding: 6px 12px; border: 1px solid var(--border); background: transparent; border-radius: 6px; cursor: pointer; color: var(--text-main); margin-right: 5px; font-size: 0.8rem; }
        
        input, select, textarea { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-main); margin-bottom: 10px; font-size: 16px; /* Evita zoom en iOS */ }

        /* Calendario */
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; padding-bottom: 15px; flex-shrink: 0; }
        .calendar-nav-btn { background: var(--bg-body); border: 1px solid var(--border); color: var(--primary); width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .weekday { background: var(--bg-sidebar); padding: 10px 0; font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-align: center; }
        .day { height: 80px; background: var(--bg-card); color: var(--text-muted); padding: 5px; position: relative; cursor: pointer; transition: background 0.2s; }
        .day:active { background: var(--bg-input); }
        .day.today { color: var(--primary); font-weight: 700; background: rgba(59, 130, 246, 0.1); }
        .day-indicator { position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }

        /* Flow & Chat */
        .flow-step-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .chat-container-wrapper { background: #0b101a; border: 1px solid var(--border); border-radius: var(--radius); flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; }
        .msg.bot { background: var(--bg-sidebar); color: var(--text-main); align-self: flex-start; }
        .msg.user { background: #005c4b; color: #e9edef; align-self: flex-end; }
        .fab { position: fixed; bottom: 25px; right: 25px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); z-index: 100; font-size: 24px; }

        /* Mobile Adjustments */
        @media(max-width: 768px) { 
            #mainApp { flex-direction: column; } 
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 4px 0 20px rgba(0,0,0,0.8); } 
            .sidebar.active { transform: translateX(0); }
            .view-padding { padding: 15px !important; }
            .card { padding: 15px !important; }
            
            #view-agenda.active { display: flex; flex-direction: column; }
            #view-agenda .card { flex: 1; display: flex; flex-direction: column; height: auto; min-height: 0; }
            #calendarDays { flex: 1; overflow-y: auto; display: grid; align-content: stretch; }
            .day { height: auto; min-height: 70px; display: flex; flex-direction: column; justify-content: flex-start; }
            
            #view-sim.active.view-padding { padding: 0 !important; }
            .chat-container-wrapper { border: none; border-radius: 0; }
        }

        /* Utils & Modals */
        .step-hidden { display: none !important; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); transition: .4s; border-radius: 34px; border: 1px solid var(--border); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); border-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        #setupWizard { background: var(--bg-body); position: fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:flex; justify-content:center; align-items:center; }
        
        #inAppNotify { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 12px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-width: 90%; width: max-content; }
        #inAppNotify.show { transform: translateX(-50%) translateY(0); }
        
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background: rgba(30, 41, 59, 0.95); border: 1px solid var(--border); padding: 10px 20px; border-radius: 20px; color: white; animation: fadeIn 0.3s; backdrop-filter: blur(4px); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; display: none; justify-content: center; align-items: flex-end; }
        .modal.active { display: flex; }

        @media(min-width: 769px) { .modal { align-items: center; } }
        
        .sheet { background: var(--bg-card); width: 100%; max-width: 500px; padding: 25px; border-radius: 20px 20px 0 0; border-top: 1px solid var(--border); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @media(min-width: 769px) { .sheet { border-radius: 16px; border: 1px solid var(--border); animation: fadeIn 0.2s; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- ESTILOS DE NAVEGACI√ìN MEJORADOS --- */
        .flow-nav { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 15px; 
    
            /* Habilita el scroll horizontal */
            overflow-x: auto; 
            white-space: nowrap; 
    
            /* Est√©tica del scroll */
            padding-bottom: 5px; 
            -webkit-overflow-scrolling: touch; /* Suavidad en m√≥viles */
            scrollbar-width: thin; /* Para Firefox */
        }

        /* Estilizar la barra de desplazamiento para que sea sutil */
        .flow-nav::-webkit-scrollbar { height: 4px; }
        .flow-nav::-webkit-scrollbar-track { background: transparent; }
        .flow-nav::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* Importante: Evita que los textos se aplasten */
        .flow-nav span, .flow-nav i { 
            flex-shrink: 0; 
        }

        .flow-nav span { color: var(--text-muted); cursor: pointer; font-weight: 500; }
        .flow-nav span:hover { color: var(--primary); text-decoration: underline; }
        .flow-nav span:last-child { color: var(--text-main); cursor: default; font-weight: 700; text-decoration: none; }

        /* Estilo para paso incompleto */
        .card-incomplete { border-left: 4px solid var(--danger) !important; background: rgba(239, 68, 68, 0.05); }
        .warning-icon { color: var(--danger); float: right; }

        /* Ajuste para evitar selecci√≥n de texto al hacer doble click */
        .flow-step-card { user-select: none; }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <div id="inAppNotify"><i class="fab fa-whatsapp" style="color:#25D366; font-size: 1.2rem;"></i> <span id="notifyText">Nuevo mensaje</span></div>
    <div id="toast-container"></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMenu()"></div>

    <!-- WIZARD -->
    <div id="setupWizard" class="step-hidden">
        <div id="stepLoading" style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:2.5rem; color:var(--primary);"></i>
            <p style="margin-top:20px; color:var(--text-muted);">Conectando...</p>
        </div>
        <div id="stepQR" class="step-hidden" style="text-align:center;">
            <h2 style="margin-top:0;">Vincular</h2>
            <div style="background:white; padding:10px; display:inline-block; border-radius:10px; margin:15px 0;">
                <canvas id="qrCanvas"></canvas>
            </div>
            <p style="color:var(--success);">Escanea el c√≥digo QR</p>
        </div>
    </div>

    <!-- APP -->
    <div id="mainApp">
        <div class="sidebar" id="sidebar">
            <div class="brand"><i class="fas fa-robot" style="color:var(--primary);"></i> FLOW CRM</div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('flow', this)"><i class="fas fa-project-diagram"></i> Flujo del Bot</div>
                <div class="menu-item" onclick="nav('activity', this)">
                    <i class="fas fa-desktop"></i> Monitor
                    <span id="socketDot" style="width:8px; height:8px; background:var(--danger); border-radius:50%; margin-left:auto; box-shadow:0 0 5px var(--danger);"></span>
                </div>
                <div class="menu-item" onclick="nav('agenda', this)"><i class="far fa-calendar-alt"></i> Agenda</div>
                <div class="menu-item" onclick="nav('contacts', this)"><i class="fas fa-users"></i> Contactos</div>
                <div class="menu-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> Configuraci√≥n</div>
                <div class="menu-item" onclick="nav('sim', this)"><i class="fas fa-gamepad"></i> Simulador</div>
                <div class="menu-item" id="installAppBtn" onclick="installPWA()"><i class="fas fa-download"></i> Instalar App</div>
                <div class="menu-item logout" onclick="requestLogout()"><i class="fas fa-power-off"></i> Salir</div>
            </div>
        </div>

        <div class="content">
            <div class="mobile-header">
                <button onclick="toggleMenu()" style="background:none; border:none; color:white; font-size:1.4rem;">‚ò∞</button>
                <span id="pageTitle" style="font-weight:700;">MONITOR</span>
                <div id="statusIndicator" class="status-badge disconnected">OFFLINE</div>
            </div>

            <!-- VISTA: MONITOR -->
            <div id="view-activity" class="view view-padding">
                <div class="card">
                    <h3 style="margin-top:0;">Monitor en Vivo</h3>
                    <div style="overflow-x:auto;">
                        <table class="act-table">
                            <thead><tr><th>Cliente</th><th>Estado</th><th>Datos</th><th>Acci√≥n</th></tr></thead>
                            <tbody id="activityBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VISTA: FLUJO -->
            <div id="view-flow" class="view active view-padding">
                <div id="flowListContainer"></div>
                <div class="fab" onclick="createNewStepPrompt()"><i class="fas fa-plus"></i></div>
            </div>

            <!-- VISTA: AGENDA -->
            <div id="view-agenda" class="view view-padding">
                <div class="card">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="monthDisplay" style="margin:0; font-size:1.1rem;"></h3>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid"><div class="weekday">DOM</div><div class="weekday">LUN</div><div class="weekday">MAR</div><div class="weekday">MI√â</div><div class="weekday">JUE</div><div class="weekday">VIE</div><div class="weekday">S√ÅB</div></div>
                    <div id="calendarDays" class="calendar-grid"></div>
                </div>
            </div>

            <!-- VISTA: CONTACTOS -->
            <div id="view-contacts" class="view view-padding">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Usuarios</h3>
                        <button class="admin-btn" onclick="openContactModal()">+ Nuevo</button>
                    </div>
                    <div id="contactsList"></div>
                </div>
            </div>

            <!-- VISTA: CONFIGURACI√ìN -->
            <div id="view-settings" class="view view-padding">
                <div class="card">
                    <h3>Horario de Atenci√≥n</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:10px; background:var(--bg-input); border-radius:8px;">
                        <span>Respuesta Autom√°tica</span>
                        <label class="switch"><input type="checkbox" id="schedActive"><span class="slider"></span></label>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label>Apertura</label><input type="time" id="schedStart"></div>
                        <div><label>Cierre</label><input type="time" id="schedEnd"></div>
                    </div>
                    <label style="margin-top:10px; display:block;">Mensaje de Ausencia</label>
                    <textarea id="schedMsg" rows="3" placeholder="No estamos disponibles..."></textarea>
                    <button class="btn-primary" onclick="saveSettings()" style="margin-top:15px;">Guardar Cambios</button>
                </div>
            </div>

            <!-- VISTA: SIMULADOR -->
            <div id="view-sim" class="view view-padding">
                <div class="chat-container-wrapper">
                    <div class="chat-msgs" id="simMsgs"></div>
                    <div style="padding:15px; border-top:1px solid var(--border); display:flex; gap:10px;">
                        <input type="text" id="simInput" placeholder="Escribe..." style="margin:0;" 
                               onkeyup="if(event.key === 'Enter') sendSim()">
                        
                        <button onmousedown="event.preventDefault()" onclick="sendSim()" class="btn-primary" style="width:auto;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal" id="stepNameModal">
        <div class="sheet" style="height:auto;">
            <h3>Nuevo Paso</h3>
            <label>Nombre del Paso (√önico)</label>
            <input type="text" id="newStepNameInput" placeholder="Ej: BIENVENIDA" style="text-transform:uppercase;">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="confirmCreateStep()" class="btn-primary" style="flex:1;">Crear</button>
                <button onclick="document.getElementById('stepNameModal').classList.remove('active')" class="admin-btn" style="flex:1;">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="logoutModal">
        <div class="sheet" style="height:auto; text-align:center;">
            <div style="width:60px; height:60px; border-radius:50%; background:rgba(239,68,68,0.1); display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
                <i class="fas fa-power-off" style="font-size:1.5rem; color:var(--danger);"></i>
            </div>
            <h3>¬øCerrar Sesi√≥n?</h3>
            <p style="color:var(--text-muted); margin-bottom:20px;">Se desconectar√° el monitor y dejar√°s de recibir alertas.</p>
            <div style="display:flex; gap:10px;">
                <button onclick="confirmLogout()" class="btn-primary" style="background:var(--danger); flex:1;">S√≠, Salir</button>
                <button onclick="document.getElementById('logoutModal').classList.remove('active')" class="admin-btn" style="flex:1;">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editorModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0;">Editar Paso</h3>
                <button onclick="document.getElementById('editorModal').classList.remove('active')" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <input type="hidden" id="stId">
            <label>Tipo de Interacci√≥n</label>
            <select id="stType" onchange="renderFields()">
                <option value="menu">üîò Men√∫ (Botones)</option>
                <option value="filtro">üëÆ Filtro Admin</option>
                <option value="input">üíæ Guardar Dato</option>
                <option value="message">üí¨ Mensaje Texto</option>
                <option value="cita">üìÖ Citas</option>
                <option value="fin_bot">üèÅ Finalizar</option>
            </select>
            <div id="wrapper-msg" style="margin-top:15px;">
                <label>Mensaje del Bot</label>
                <textarea id="stMsg" rows="3" placeholder="Hola {{nombre}}..."></textarea>
            </div>
            <div id="wrapper-media" style="margin-top:15px; background:var(--bg-input); padding:10px; border-radius:8px;">
                <label>Multimedia (Fotos/Videos)</label>
                <div id="galleryContainer" style="display:flex; gap:10px; overflow-x:auto; padding:5px 0;"></div>
                <input type="file" id="imgUpload" accept="image/*" multiple style="display:none" onchange="uploadImages(this)">
                <button onclick="document.getElementById('imgUpload').click()" class="admin-btn" style="width:100%; border-style:dashed; margin-top:5px;">+ Subir Archivo</button>
            </div>
            <div id="dynFields" style="margin-top:15px;"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="saveStep()" class="btn-primary" style="flex:1;">Guardar</button>
                <button onclick="delStep()" style="background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid var(--danger); padding:10px; border-radius:8px;"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 id="modalDateTitle" style="margin:0;">Eventos</h3>
                <button onclick="document.getElementById('dayModal').classList.remove('active')" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <div id="modalApptList" style="flex:1; overflow-y:auto; margin-bottom:15px;"></div>
            <button onclick="document.getElementById('eventForm').style.display='block'; this.style.display='none'" id="btnAddEvent" class="admin-btn" style="width:100%; padding:15px; border-style:dashed;">+ Agendar Manualmente</button>
            <div id="eventForm" style="display:none; background:var(--bg-input); padding:15px; border-radius:10px; margin-top:10px;">
                <input type="hidden" id="evtOldTime">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Hora</label><input type="time" id="evtTime"></div>
                    <div style="flex:1"><label>Tel√©fono</label><input type="tel" id="evtPhone"></div>
                </div>
                <label>Nombre</label><input type="text" id="evtName">
                <label>Nota</label><input type="text" id="evtNote">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="saveEvent()" class="btn-primary" style="flex:1;">Guardar</button>
                    <button onclick="document.getElementById('eventForm').style.display='none'; document.getElementById('btnAddEvent').style.display='block'" class="admin-btn">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="contactModal">
        <div class="sheet">
            <h3>Nuevo Contacto</h3>
            <label>Nombre</label><input type="text" id="newContName">
            <label>Tel√©fono (con pa√≠s)</label><input type="tel" id="newContPhone" placeholder="Ej: 521...">
            <div style="display:flex; justify-content:space-between; margin:15px 0;">
                <span>Activar Bot</span>
                <label class="switch"><input type="checkbox" id="newContEnable" checked><span class="slider"></span></label>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveNewContact()" class="btn-primary" style="flex:1;">Guardar</button>
                <button onclick="document.getElementById('contactModal').classList.remove('active')" class="admin-btn" style="flex:1;">Cancelar</button>
            </div>
        </div>
    </div>

<script>
    const API_BASE = ''; 
    let flow = {}, users = [];
    let pollingInterval = null, deferredPrompt;
    let currentRefDate = new Date();

    const socket = io({ reconnection: true });
    socket.on('connect', () => { updateConnStatus(true); loadActivity(); });
    socket.on('disconnect', () => { updateConnStatus(false); });

    socket.on('message', (data) => {
        if (!data.fromMe && document.visibilityState === 'visible') {
            showInAppNotify(data.text || "üì∑ Imagen recibida");
            const audio = document.getElementById('alertSound');
            if(audio) { audio.volume = 0.5; audio.play().catch(()=>{}); }
        } else if (!data.fromMe) {
            new Notification("Nuevo Mensaje", { body: data.text || "Archivo", icon: "logo.svg" });
        }
        loadActivity(); 
        const simPhone = '5218991234567';
        const dest = (data.to||'').replace(/\D/g, ''), orig = (data.from||'').replace(/\D/g, '');
        // FIX: Invertir fromMe para el simulador para que los mensajes del bot aparezcan a la izquierda y los m√≠os a la derecha
        if (dest.includes(simPhone) || orig.includes(simPhone)) addMsg(data.text, !data.fromMe);
    });

    function showInAppNotify(text) {
        const el = document.getElementById('inAppNotify');
        document.getElementById('notifyText').innerText = text.substring(0, 30) + (text.length>30?'...':'');
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 4000);
    }

    function updateConnStatus(online) {
        const dot = document.getElementById('socketDot'), badge = document.getElementById('statusIndicator');
        if(online) { dot.style.background='var(--success)'; dot.style.boxShadow='0 0 5px var(--success)'; badge.className='status-badge connected'; badge.innerText='ONLINE'; } 
        else { dot.style.background='var(--danger)'; dot.style.boxShadow='0 0 5px var(--danger)'; badge.className='status-badge disconnected'; badge.innerText='OFFLINE'; }
    }

    window.onload = () => {
        document.getElementById('setupWizard').classList.remove('step-hidden');
        // FIX: No pedir permiso al cargar, esperar a la interacci√≥n del usuario
        
        const checkStatus = async () => {
            try {
                const res = await (await fetch(`${API_BASE}/api/status`)).json();
                if(res.status === 'connected') {
                    document.getElementById('setupWizard').classList.add('step-hidden');
                    document.getElementById('mainApp').classList.add('visible');
                    loadAll(); loadActivity();
                } else if(res.qr) {
                    document.getElementById('stepLoading').classList.add('step-hidden');
                    document.getElementById('stepQR').classList.remove('step-hidden');
                    new QRious({element: document.getElementById('qrCanvas'), value: res.qr, size:200});
                }
            } catch(e){}
            if(document.getElementById('setupWizard').classList.contains('step-hidden')) return;
            setTimeout(checkStatus, 3000);
        };
        checkStatus();

        // --- PWA SERVICE WORKER REGISTRATION (Re-added) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail', err));
        }

        // --- SOLUCI√ìN PARA EL TECLADO EN M√ìVIL ---
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                // Cuando el teclado cambia el tama√±o de la pantalla...
                const container = document.querySelector('.chat-msgs');
                
                // Esperamos un instante a que el navegador termine de redibujar
                setTimeout(() => {
                    // Forzamos el scroll hasta el √∫ltimo mensaje
                    container.scrollTop = container.scrollHeight;
                    
                    // Aseguramos que el input siga visible
                    document.getElementById('simInput').scrollIntoView({block: 'nearest'});
                }, 100);
            });
        }
    };

    // FIX: Pedir permisos de notificaci√≥n en el primer clic/toque en la pantalla
    document.body.addEventListener('click', function() {
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
    }, { once: true });

    async function loadAll() {
        try { flow = await (await fetch(`${API_BASE}/api/flow`)).json(); renderFlowList(); } catch(e){}
        try { const s = await (await fetch(`${API_BASE}/api/settings`)).json(); if(s.schedule) { document.getElementById('schedActive').checked = s.schedule.active; document.getElementById('schedStart').value = s.schedule.start; document.getElementById('schedEnd').value = s.schedule.end; document.getElementById('schedMsg').value = s.schedule.offline_message; } } catch(e){}
    }
    
    async function loadActivity() {
        try {
            if (Object.keys(flow).length === 0) flow = await (await fetch(`${API_BASE}/api/flow`)).json();
            
            users = await (await fetch(`${API_BASE}/api/users`)).json();
            const tb = document.getElementById('activityBody'); 
            tb.innerHTML = '';

            users.filter(u => u.phone !== 'TEST_SIMULADOR')
                 .sort((a,b) => new Date(b.last_active) - new Date(a.last_active))
                 .forEach(u => {
                    const s = flow[u.current_step] || {};
                    
                    // --- LOGICA BOTONES (ACCIONES) ---
                    let btns = '';
                    if(s.type === 'filtro' && s.options) {
                        s.options.forEach(o => {
                            btns += `<button class="admin-btn" onclick="crmAction('${u.phone}', '${o.next_step}')" style="border-color:var(--primary); color:var(--primary); margin-top:5px;">${o.label}</button>`;
                        });
                    }

                    // --- LOGICA NUEVA: FORMATEAR VARIABLES ---
                    let varsHtml = '<span style="color:var(--text-muted); font-size:0.8rem;">-</span>';
                    
                    // CORRECCI√ìN: Usamos 'history' en lugar de 'variables'
                    if (u.history && Object.keys(u.history).length > 0) {
                        varsHtml = '';
                        Object.keys(u.history).forEach(key => {
                            // Muestra: Nombre: Juan (en peque√±ito)
                            varsHtml += `<div style="font-size:0.85rem; white-space:nowrap;">
                                <span style="color:#64748b; font-weight:bold;">${key}:</span> 
                                <span style="color:var(--text-main);">${u.history[key]}</span>
                            </div>`;
                        });
                    }

                    // --- RENDERIZAR FILA ---
                    // Agregamos la celda nueva <td>${varsHtml}</td> en medio
                    tb.innerHTML += `
                    <tr>
                        <td>
                            <b>${u.phone}</b><br>
                            <small>${timeAgo(u.last_active)}</small>
                        </td>
                        <td>
                            <span class="status-badge connected" style="background:var(--bg-input); color:var(--text-muted);">
                                ${u.current_step}
                            </span>
                        </td>
                        <td>${varsHtml}</td> <td>${btns}</td>
                    </tr>`;
            });
        } catch(e){ console.error(e); }
    }
    async function crmAction(phone, step) { await fetch(`${API_BASE}/api/crm/execute`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, stepId: step }) }); loadActivity(); }
    // --- VARIABLES DE NAVEGACI√ìN ---
    let flowPath = []; 

    function renderFlowList() {
        const c = document.getElementById('flowListContainer'); 
        c.innerHTML = '';

        // 1. Barra de Navegaci√≥n (Breadcrumbs) con SCROLL
        if (flowPath.length > 0) {
            // Bot√≥n para regresar un nivel (Padre inmediato)
            let navHtml = `<div class="flow-nav" id="breadcrumbNav">`;
            
            // Agregamos bot√≥n "Atr√°s" al inicio
            navHtml += `<button onclick="jumpToStep(${flowPath.length - 2})" class="admin-btn" style="margin-right:10px; border-radius:50%; width:30px; height:30px; padding:0; display:flex; align-items:center; justify-content:center;"><i class="fas fa-arrow-left"></i></button>`;

            navHtml += `<span onclick="resetFlowNav()">Inicio</span>`;
            
            flowPath.forEach((step, index) => {
                if(index === flowPath.length - 1) {
                    navHtml += ` <i class="fas fa-chevron-right" style="font-size:0.7rem; opacity:0.5;"></i> <span>${step}</span>`;
                } else {
                    navHtml += ` <i class="fas fa-chevron-right" style="font-size:0.7rem; opacity:0.5;"></i> <span onclick="jumpToStep(${index})">${step}</span>`;
                }
            });
            navHtml += `</div>`;
            c.innerHTML += navHtml;

            // AUTO-SCROLL: Mover la barra al final para ver el paso actual
            setTimeout(() => {
                const nav = document.getElementById('breadcrumbNav');
                if(nav) nav.scrollLeft = nav.scrollWidth;
            }, 50);
        }

        // 2. L√≥gica de Jerarqu√≠a (Igual que antes)
        let stepsToShow = [];
        if (flowPath.length === 0) {
            stepsToShow = findFlowRoots();
            if(stepsToShow.length === 0 && Object.keys(flow).length > 0) {
                stepsToShow = [Object.keys(flow).sort()[0]]; 
            }
        } else {
            const parentId = flowPath[flowPath.length - 1];
            stepsToShow = getChildrenSteps(parentId);
        }

        if(stepsToShow.length === 0 && flowPath.length > 0) {
            c.innerHTML += `<div style="text-align:center; padding:20px; color:var(--text-muted);">
                <p>Este paso no tiene salidas configuradas.</p>
                <button class="admin-btn" style="margin-top:10px; border-color:var(--primary); color:var(--primary);" onclick="edit('${flowPath[flowPath.length-1]}')">
                    <i class="fas fa-pen"></i> Editar "${flowPath[flowPath.length-1]}"
                </button>
            </div>`;
        }

        // 3. Renderizar Tarjetas (Igual que antes)
        stepsToShow.forEach(k => {
            const step = flow[k];
            if(!step) return; 
            let isInc = false;
            if (step.type !== 'fin_bot' && !step.next_step && (!step.options || step.options.length === 0)) {
                isInc = true;
            }

            c.innerHTML += `
            <div class="flow-step-card ${isInc ? 'card-incomplete' : ''}" 
                 onclick="enterStep('${k}')" 
                 style="position:relative; padding-right:50px;">
                <div style="flex:1">
                    <strong>${k}</strong> ${isInc ? '<i class="fas fa-exclamation-circle warning-icon" title="Paso incompleto"></i>' : ''}
                    <br><small style="color:var(--text-muted);">${step.type}</small>
                    ${step.message ? `<div style="font-size:0.85em; color:#64748b; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${step.message}</div>` : ''}
                </div>
                <i class="fas fa-chevron-right" style="opacity:0.5;"></i>
                <button onclick="event.stopPropagation(); edit('${k}')" 
                        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); 
                               background:var(--bg-input); border:1px solid var(--border); 
                               color:var(--text-muted); width:32px; height:32px; border-radius:6px; cursor:pointer; z-index:10;">
                    <i class="fas fa-pen" style="font-size:12px;"></i>
                </button>
            </div>`;
        });
    }

    // --- FUNCIONES AUXILIARES ---

    function enterStep(stepId) {
        // Solo navega, no edita
        flowPath.push(stepId);
        renderFlowList();
    }

    function resetFlowNav() {
        flowPath = [];
        renderFlowList();
    }

    function jumpToStep(index) {
        flowPath = flowPath.slice(0, index + 1);
        renderFlowList();
    }

    function getChildrenSteps(parentId) {
        const parent = flow[parentId];
        if (!parent) return [];
        let kids = [];
        if (parent.next_step && flow[parent.next_step]) kids.push(parent.next_step);
        if (parent.options && Array.isArray(parent.options)) {
            parent.options.forEach(opt => {
                if (opt.next_step && flow[opt.next_step] && !kids.includes(opt.next_step)) {
                    kids.push(opt.next_step);
                }
            });
        }
        return kids;
    }

    function findFlowRoots() {
        const allSteps = Object.keys(flow);
        // Si no hay pasos, retornar vac√≠o
        if(allSteps.length === 0) return [];

        const targetedSteps = new Set();
        allSteps.forEach(k => {
            const s = flow[k];
            if (s.next_step) targetedSteps.add(s.next_step);
            if (s.options) s.options.forEach(o => { if(o.next_step) targetedSteps.add(o.next_step); });
        });
        
        // Pasos que nadie apunta a ellos
        const roots = allSteps.filter(s => !targetedSteps.has(s));
        
        // IMPORTANTE: Si roots tiene muchos elementos, es porque esos pasos NO est√°n conectados a√∫n.
        // Si todos est√°n desconectados, todos son roots.
        return roots;
    }
    let currentMediaList = [];
    function edit(id) {
        const d = flow[id]; document.getElementById('stId').value = id; document.getElementById('stType').value = d.type;
        document.getElementById('stMsg').value = d.message || '';
        currentMediaList = d.media || [];
        renderGallery(); renderFields(); document.getElementById('editorModal').classList.add('active');
    }
    function renderGallery() { 
        const c = document.getElementById('galleryContainer'); c.innerHTML=''; 
        currentMediaList.forEach((u,i) => c.innerHTML += `<div style="min-width:60px; height:60px; background:url(${u}) center/cover; border-radius:5px; position:relative;"><button onclick="currentMediaList.splice(${i},1); renderGallery()" style="position:absolute; top:-5px; right:-5px; background:red; border-radius:50%; width:18px; height:18px; border:none; color:white; font-size:10px;">x</button></div>`); 
    }
    async function uploadImages(inp) { 
        if(!inp.files.length) return; const fd = new FormData(); for(let f of inp.files) fd.append('images', f);
        const res = await (await fetch(`${API_BASE}/api/upload`, {method:'POST', body:fd})).json();
        if(res.urls) { currentMediaList.push(...res.urls); renderGallery(); }
    }

    const getSelectOptions = (selected) => {
        let opts = '<option value="">-- Elegir --</option>';
        Object.keys(flow).sort().forEach(k => {
            opts += `<option value="${k}" ${k===selected?'selected':''}>${k}</option>`;
        });
        return opts;
    };

    function renderFields() {
        const type = document.getElementById('stType').value;
        const id = document.getElementById('stId').value;
        const d = flow[id] || {};
        const c = document.getElementById('dynFields');
        const wrapMsg = document.getElementById('wrapper-msg'), wrapMedia = document.getElementById('wrapper-media');
        wrapMsg.style.display = type==='cita'?'none':'block'; wrapMedia.style.display = type==='cita'?'none':'block';

        let html = '';
        if(type === 'menu' || type === 'filtro') {
            html += `<label>Opciones</label><div id="optsList">`;
            (d.options||[]).forEach(o => html += `<div style="display:flex; gap:5px; margin-bottom:5px;"><input class="o-lbl" value="${o.label}"><select class="o-nxt">${getSelectOptions(o.next_step)}</select><button onclick="this.parentElement.remove()" style="color:var(--danger); background:none; border:none;">‚úï</button></div>`);
            html += `</div><button class="admin-btn" onclick="addOptRow()">+ Opci√≥n</button>`;
            if(type==='menu') html += `<label style="margin-top:10px">Keywords</label><input id="stKw" value="${(d.keywords||[]).join(', ')}">`;
            if(type==='filtro') html += `<label style="margin-top:10px">Admin Tel</label><input id="stAdm" value="${d.admin_number||''}">`;
        } else if (type === 'input') {
            html += `<label>Variable a Guardar</label><input id="stVar" value="${d.save_var||''}"><label>Siguiente</label><select id="stNext">${getSelectOptions(d.next_step)}</select>`;
        } else {
            html += `<label>Siguiente</label><select id="stNext">${getSelectOptions(d.next_step)}</select>`;
        }
        c.innerHTML = html;
    }
    function addOptRow() { document.getElementById('optsList').insertAdjacentHTML('beforeend', `<div style="display:flex; gap:5px; margin-bottom:5px;"><input class="o-lbl" placeholder="Bot√≥n"><select class="o-nxt">${getSelectOptions('')}</select><button onclick="this.parentElement.remove()" style="color:var(--danger); background:none; border:none;">‚úï</button></div>`); }
    
    async function saveStep() {
        const id = document.getElementById('stId').value, type = document.getElementById('stType').value;
        const data = { type, message: document.getElementById('stMsg').value, media: currentMediaList };
        if(document.getElementById('stNext')) data.next_step = document.getElementById('stNext').value;
        if(document.getElementById('stVar')) data.save_var = document.getElementById('stVar').value;
        if(document.getElementById('stKw')) data.keywords = document.getElementById('stKw').value.split(',').map(s=>s.trim());
        if(document.getElementById('stAdm')) data.admin_number = document.getElementById('stAdm').value;
        if(document.getElementById('optsList')) {
            data.options = [];
            document.querySelectorAll('#optsList div').forEach(row => {
                const l = row.querySelector('.o-lbl').value, n = row.querySelector('.o-nxt').value;
                if(l && n) data.options.push({label:l, trigger:l, next_step:n});
            });
        }
        await fetch('/api/flow/step', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ stepId: id, stepData: data }) });
        flow[id] = data; renderFlowList(); document.getElementById('editorModal').classList.remove('active');
    }
    
    function createNewStepPrompt() { 
        document.getElementById('newStepNameInput').value = '';
        document.getElementById('stepNameModal').classList.add('active');
        setTimeout(() => document.getElementById('newStepNameInput').focus(), 100);
    }
    function confirmCreateStep() {
        const n = document.getElementById('newStepNameInput').value.toUpperCase().trim();
        if(!n) return alert("El nombre es requerido");
        if(flow[n]) return alert("Ya existe un paso con ese nombre");
        flow[n] = {type:'message'}; 
        renderFlowList(); 
        document.getElementById('stepNameModal').classList.remove('active');
        edit(n);
    }
    
    function requestLogout() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        document.getElementById('logoutModal').classList.add('active');
    }
    async function confirmLogout() {
        await fetch(`${API_BASE}/api/logout`, { method: 'POST' }); 
        location.reload();
    }
    function resetSession() { requestLogout(); }
    
    async function delStep() { await fetch('/api/flow/step/'+document.getElementById('stId').value, {method:'DELETE'}); delete flow[document.getElementById('stId').value]; renderFlowList(); document.getElementById('editorModal').classList.remove('active'); }

    async function renderCalendar() {
        const now = currentRefDate, m = now.getMonth(), y = now.getFullYear();
        document.getElementById('monthDisplay').innerText = `${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][m]} ${y}`;
        const g = document.getElementById('calendarDays'); g.innerHTML = '';
        let appts = {}; try { appts = await (await fetch(`${API_BASE}/api/agenda`)).json(); } catch(e){}
        const firstDay = new Date(y, m, 1).getDay(), daysInMonth = new Date(y, m+1, 0).getDate();
        for(let i=0; i<firstDay; i++) g.innerHTML += `<div></div>`;
        for(let i=1; i<=daysInMonth; i++) { 
            const k = `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
            const count = (appts[k]||[]).length;
            const isToday = new Date().toDateString() === new Date(y,m,i).toDateString();
            g.innerHTML += `<div class="day ${isToday?'today':''}" onclick="openDayModal('${k}')">${i} ${count?`<span class="day-indicator">${count}</span>`:''}</div>`; 
        }
    }
    function changeMonth(d) { currentRefDate.setMonth(currentRefDate.getMonth()+d); renderCalendar(); }
    async function openDayModal(date) {
        document.getElementById('modalDateTitle').innerText = date;
        const list = document.getElementById('modalApptList'); list.innerHTML = 'Cargando...';
        const all = await (await fetch(`${API_BASE}/api/agenda`)).json();
        const appts = all[date] || [];
        list.innerHTML = appts.length ? '' : '<div style="text-align:center; padding:20px; color:#666;">Sin citas</div>';
        appts.sort((a,b)=>a.time.localeCompare(b.time)).forEach(c => list.innerHTML += `<div style="background:var(--bg-input); padding:10px; margin-bottom:5px; border-radius:8px;"><b>${c.time}</b> ${c.name} <br><small>${c.phone}</small> <button style="float:right; color:red; background:none; border:none;" onclick="delAppt('${date}','${c.time}')">x</button></div>`);
        document.getElementById('evtOldTime').dataset.date = date;
        document.getElementById('dayModal').classList.add('active');
    }
    async function saveEvent() {
        const d = { date: document.getElementById('evtOldTime').dataset.date, time: document.getElementById('evtTime').value, name: document.getElementById('evtName').value, phone: document.getElementById('evtPhone').value, note: document.getElementById('evtNote').value };
        if(!d.time || !d.name) return alert("Faltan datos");
        await fetch(`${API_BASE}/api/agenda/book`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) });
        document.getElementById('eventForm').style.display='none'; document.getElementById('btnAddEvent').style.display='block';
        openDayModal(d.date); renderCalendar();
    }
    async function delAppt(d, t) { await fetch(`${API_BASE}/api/agenda/delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({date:d, time:t}) }); openDayModal(d); renderCalendar(); }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
    function nav(v, btn) { 
        document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); 
        document.getElementById('view-'+v).classList.add('active'); 
        if(btn) btn.classList.add('active'); 
        document.getElementById('sidebar').classList.remove('active'); 
        document.getElementById('sidebarOverlay').classList.remove('active'); 
        
        if(v==='agenda') renderCalendar();
        if(v==='contacts') renderContacts(); 
    }
    function timeAgo(date) { if(!date) return '-'; const s = Math.floor((new Date()-new Date(date))/1000); if(s<60) return 'Ahora'; if(s<3600) return Math.floor(s/60)+'m'; return Math.floor(s/3600)+'h'; }
    async function saveSettings() {
        const s = { active: document.getElementById('schedActive').checked, start: document.getElementById('schedStart').value, end: document.getElementById('schedEnd').value, offline_message: document.getElementById('schedMsg').value };
        await fetch(`${API_BASE}/api/settings`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({schedule:s})});
        showToast('Guardado');
    }
    function showToast(m) { const c=document.getElementById('toast-container'); c.innerHTML+=`<div class="toast">${m}</div>`; setTimeout(()=>c.innerHTML='', 3000); }
    
    async function renderContacts() {
        try { 
            const list = await (await fetch(`${API_BASE}/api/contacts`)).json(); 
            const c = document.getElementById('contactsList'); 
            if(!list || list.length === 0) {
                c.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Sin usuarios registrados</div>';
                return;
            }
            let htmlBuffer = ''; 
            list.forEach(u => htmlBuffer += `<div style="display:flex; justify-content:space-between; padding:16px; border-bottom:1px solid var(--border); align-items:center;" class="toggle-row"><div style="display:flex; align-items:center; gap:12px;"><div style="width:36px; height:36px; background:var(--bg-input); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:var(--text-muted);">${u.name?u.name[0].toUpperCase():'#'}</div><div><b style="color:var(--text-main); font-size:0.95rem; display:block;">${u.name||u.phone}</b><div style="color:var(--text-muted); font-size:0.8rem;">${u.phone}</div></div></div><label class="switch"><input type="checkbox" ${u.bot_enabled?'checked':''} onchange="toggleUser('${u.phone}', this.checked)"><span class="slider"></span></label></div>`); 
            c.innerHTML = htmlBuffer; 
        } catch (e) {
            console.error(e);
            document.getElementById('contactsList').innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger);">Error cargando usuarios</div>';
        }
    }
    async function toggleUser(phone, en) { await fetch(`${API_BASE}/api/contacts/toggle`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone, enable:en})}); showToast('Actualizado'); }
    function openContactModal() { document.getElementById('contactModal').classList.add('active'); }
    async function saveNewContact() { const name = document.getElementById('newContName').value, phone = document.getElementById('newContPhone').value, enable = document.getElementById('newContEnable').checked; if(!phone) return; await fetch(`${API_BASE}/api/contacts/add`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, phone, enable})}); document.getElementById('contactModal').classList.remove('active'); renderContacts(); }

    function sendSim() { const t=document.getElementById('simInput'); if(!t.value)return; addMsg(t.value,true); fetch(`${API_BASE}/api/simulate/text`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:'5218991234567', text:t.value}) }); t.value=''; }
    function addMsg(t, me) { document.getElementById('simMsgs').innerHTML+=`<div class="msg ${me?'user':'bot'}">${t}</div>`; const c=document.querySelector('.chat-msgs'); c.scrollTop=c.scrollHeight; }

    // --- PWA INSTALLATION (Re-added & Improved) ---
    window.addEventListener('beforeinstallprompt', (e) => { 
        e.preventDefault(); 
        deferredPrompt=e; 
        document.getElementById('installAppBtn').style.display='flex'; 
    });

    async function installPWA() { 
        if(deferredPrompt) { 
            deferredPrompt.prompt(); 
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('installAppBtn').style.display='none';
            }
            deferredPrompt=null; 
        } 
    }
</script>
</body>
</html>
